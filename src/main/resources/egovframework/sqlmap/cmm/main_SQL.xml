<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >

<sqlMap namespace="main">

<resultMap id="MAIN_R_01" class="web.main.vo.MAINPRDTVO">
    <result property="corpId" 		column="CORP_ID" />
    <result property="prdtNum" 		column="PRDT_NUM" />
    <result property="prdtNm" 		column="PRDT_NM" />
    <result property="corpNm" 		column="CORP_NM" />
    <result property="nmlAmt" 		column="NML_AMT" />
    <result property="saleAmt" 		column="SALE_AMT" />
    <result property="simpleExp" 	column="SIMPLE_EXP" />
    <result property="disPer" 		column="DIS_PER" />
    <result property="savePath" 	column="SAVE_PATH" />
    <result property="saveFileNm" 	column="SAVE_FILE_NM" />
    <result property="gpaAvg" 		column="GPA_AVG" />
</resultMap>

<resultMap id="MAIN_R_02" class="web.main.vo.MAINPRDTVO">
    <result property="prdtNum" 		column="PRDT_NUM" />
    <result property="prdtNm" 		column="PRDT_NM" />
    <result property="corpId" 		column="CORP_ID" />
    <result property="corpNm" 		column="CORP_NM" />
    <result property="nmlAmt" 		column="NML_AMT" />
    <result property="saleAmt" 		column="SALE_AMT" />
    <result property="simpleExp" 	column="SIMPLE_EXP" />
    <result property="disPer" 		column="DIS_PER" />
    <result property="savePath" 	column="SAVE_PATH" />
    <result property="saveFileNm" 	column="SAVE_FILE_NM" />
    <result property="gpaAvg" 		column="GPA_AVG" />
    <result property="ctgr" 		column="CTGR" />
    <result property="prdtDiv" 		column="PRDT_DIV" />
    <result property="spDivSn" 		column="SP_DIV_SN" />
    <result property="spOptSn" 		column="SP_OPT_SN" />
</resultMap>

<resultMap id="MAIN_R_10" class="web.main.vo.MAINPRDTVO">
    <result property="prdtNum" 		column="PRDT_NUM" />
    <result property="prdtNm" 		column="PRDT_NM" />
    <result property="corpNm" 		column="CORP_NM" />
    <result property="nmlAmt" 		column="NML_AMT" />
    <result property="saleAmt" 		column="SALE_AMT" />
    <result property="saveFileNm" 	column="SAVE_FILE_NM" />
</resultMap>

<resultMap id="MAIN_R_11" class="web.main.vo.MAINPRDTVO">
    <result property="corpId" 		column="CORP_ID" />
    <result property="prdtNum" 		column="PRDT_NUM" />
    <result property="prdtNm" 		column="PRDT_NM" />
    <result property="corpNm" 		column="CORP_NM" />
    <result property="nmlAmt" 		column="NML_AMT" />
    <result property="saleAmt" 		column="SALE_AMT" />
    <result property="simpleExp" 	column="SIMPLE_EXP" />
    <result property="disPer" 		column="DIS_PER" />
    <result property="savePath" 	column="SAVE_PATH" />
    <result property="saveFileNm" 	column="SAVE_FILE_NM" />
    <result property="gpaAvg" 		column="GPA_AVG" />
    <result property="daypriceYn" 	column="DAYPRICE_YN" />
    <result property="adAreaNm" 	column="AD_AREA_NM" />
    <result property="tamnacardYn" 	column="TAMNACARD_YN" />
</resultMap>

<resultMap id="MAIN_R_21" class="web.main.vo.MAINPRDTVO">
    <result property="prdtNum" 		column="PRDT_NUM" />
    <result property="prdtNm" 		column="PRDT_NM" />
    <result property="corpId" 		column="CORP_ID" />
    <result property="corpNm" 		column="CORP_NM" />
    <result property="nmlAmt" 		column="NML_AMT" />
    <result property="saleAmt" 		column="SALE_AMT" />
    <result property="simpleExp" 	column="SIMPLE_EXP" />
    <result property="disPer" 		column="DIS_PER" />
    <result property="savePath" 	column="SAVE_PATH" />
    <result property="saveFileNm" 	column="SAVE_FILE_NM" />
    <result property="gpaAvg" 		column="GPA_AVG" />
    <result property="ctgr" 		column="CTGR" />
    <result property="svDivSn" 		column="SV_DIV_SN" />
    <result property="svOptSn" 		column="SV_OPT_SN" />
    <result property="superbSvYn"	column="SUPERB_SV_YN" />
</resultMap>

<resultMap id="MAIN_R_23" class="oss.site.vo.MAINHOTPRDTVO">
    <result property="prdtNum" column="PRDT_NUM" />
    <result property="corpId"  column="CORP_ID" />
    <result property="prdtDiv" column="PRDT_DIV" />
    <result property="prdtNm"  column="PRDT_NM" />
    <result property="prdtExp" column="PRDT_EXP" />
    <result property="imgPath" column="IMG_PATH" />
    <result property="etcExp"  column="ETC_EXP" />
    <result property="nmlAmt"  column="NML_AMT" />
    <result property="saleAmt" column="SALE_AMT" />
    <result property="printSn" column="PRINT_SN" />
</resultMap>

<resultMap id="MAIN_R_25" class="oss.site.vo.MAINHOTPRDTVO">
    <result property="prdtNum" column="PRDT_NUM" />
    <result property="prdtDiv" column="PRDT_DIV" />
    <result property="prdtExp" column="PRDT_EXP" />
    <result property="imgPath" column="IMG_PATH" />
</resultMap>

<resultMap id="MAIN_R_26" class="oss.site.vo.MAINAREAPRDTVO">
    <result property="prdtNum" column="PRDT_NUM" />
    <result property="areaDiv" column="AREA_DIV" />
    <result property="prdtDiv" column="PRDT_DIV" />
    <result property="prdtGubun" column="PRDT_GUBUN" />
    <result property="prdtNm"  column="PRDT_NM" />
    <result property="ctgr"    column="CTGR" />
    <result property="ctgrNm"  column="CTGR_NM" />
    <result property="imgPath" column="IMG_PATH" />
</resultMap>

<resultMap id="MAIN_R_27" class="oss.site.vo.MAINCTGRRCMDVO">
    <result property="prdtNum"      column="PRDT_NUM" />
    <result property="corpId"       column="CORP_ID" />
    <result property="prdtDiv"      column="PRDT_DIV" />
    <result property="prdtNm"       column="PRDT_NM" />
    <result property="prdtExp"      column="PRDT_EXP" />
    <result property="imgPath"      column="IMG_PATH" />
    <result property="etcExp"       column="ETC_EXP" />
    <result property="nmlAmt"       column="NML_AMT" />
    <result property="saleAmt"      column="SALE_AMT" />
    <result property="eventCnt"     column="EVENT_CNT" />
    <result property="couponCnt"    column="COUPON_CNT" />
    <result property="daypriceYn"   column="DAYPRICE_YN" />
    <result property="tamnacardYn" 	column="TAMNACARD_YN" />
</resultMap>

<resultMap id="MAIN_R_28" class="oss.site.vo.MAINCTGRRCMDVO">
    <result property="prdtDiv" column="PRDT_DIV" />
    <result property="prdtNum" column="PRDT_NUM" />
    <result property="prdtNm"  column="PRDT_NM" />
    <result property="prdtExp" column="PRDT_EXP" />
    <result property="imgPath" column="IMG_PATH" />
    <result property="etcExp"  column="ETC_EXP" />
    <result property="nmlAmt"  column="NML_AMT" />
    <result property="saleAmt" column="SALE_AMT" />
</resultMap>

<resultMap id="MW_MAIN_R_14" class="web.main.vo.MAINPRDTVO">
    <result property="corpId" 		column="CORP_ID" />
    <result property="prdtNum" 		column="PRDT_NUM" />
    <result property="prdtNm" 		column="PRDT_NM" />
    <result property="nmlAmt" 		column="NML_AMT" />
    <result property="saleAmt" 		column="SALE_AMT" />
    <result property="simpleExp" 	column="SIMPLE_EXP" />
    <result property="savePath" 	column="SAVE_PATH" />
    <result property="saveFileNm" 	column="SAVE_FILE_NM" />
    <result property="adAreaNm"		column="AD_AREA_NM" />
</resultMap>

<resultMap id="BEST_AD_R_01" class="web.main.vo.MAINPRDTVO">
    <result property="corpId" 		column="CORP_ID" />
    <result property="corpNm"		column="AD_NM" />
    <result property="simpleExp"	column="AD_SIMPLE_EXP" />
    <result property="saleAmt"		column="SALE_AMT" />
    <result property="savePath"		column="SAVE_PATH" />
    <result property="saveFileNm"	column="SAVE_FILE_NM" />
    <result property="tamnacardYn" 	column="TAMNACARD_YN" />
</resultMap>

<resultMap id="TAMNAO_PARTNER_R_01" class="oss.user.vo.USERVO">
    <result property="partnerCd" 		column="PARTNER_CD" />
    <result property="partnerNm"		column="PARTNER_NM" />
    <result property="totalAccessCnt"	column="TOTAL_ACCESS_CNT" />
</resultMap>

<resultMap id="TAMNAO_PARTNER_R_03" class="oss.user.vo.USERVO">
    <result property="partnerCd" 		column="PARTNER_CD" />
    <result property="partnerNm"		column="PARTNER_NM" />
</resultMap>

<resultMap id="TAMNAO_PARTNER_R_04" class="oss.user.vo.USERVO">
	<result property="year" 			column="YEAR" />
	<result property="mm" 				column="MM" />
	<result property="partnerCd" 		column="PARTNER_CD" />
    <result property="accessCnt" 		column="ACCESS_CNT" />
</resultMap>

<!-- 당일 특가(숙박) -->
<select id="MAIN_S_01" resultMap="MAIN_R_01">
<![CDATA[
SELECT CORP_ID
     , PRDT_NUM
     , PRDT_NM
     , CORP_NM
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT CORP_ID
             , PRDT_NUM
             , PRDT_NM
             , CORP_NM
             , NML_AMT
             , SALE_AMT
             , SIMPLE_EXP
             , DIS_PER
             , SAVE_PATH
             , SAVE_FILE_NM
             , GPA_AVG
          FROM (SELECT T_DFT.CORP_ID
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.PRDT_NM
                     , T_DFT.AD_NM          AS CORP_NM
                     , T_AMT.NML_AMT
                     , T_AMT.DAYPRICE_AMT	AS SALE_AMT
                     , T_DFT.AD_SIMPLE_EXP  AS SIMPLE_EXP
                     , CASE WHEN T_AMT.NML_AMT != 0 THEN 100 - (TRUNC(T_AMT.DAYPRICE_AMT / T_AMT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_IMG.SAVE_PATH
                     , T_IMG.SAVE_FILE_NM
                     , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
                     , ROW_NUMBER() OVER(PARTITION BY T_DFT.CORP_ID ORDER BY T_AMT.DAYPRICE_AMT ASC, T_PRDT.PRDT_NUM) AS RK
                  FROM TB_AD_PRDTINF T_PRDT
                 INNER JOIN TB_AD_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , SALE_AMT
                                  , NML_AMT
                                  , DAYPRICE_YN
                                  , DAYPRICE_AMT
                               FROM TB_AD_AMTINF
                              WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                                AND DAYPRICE_YN = 'Y'
                                AND DAYPRICE_AMT > 0
                            ) T_AMT
                    ON T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , TOTAL_ROOM_NUM
                                  , USE_ROOM_NUM
                                  , DDL_YN
                               FROM TB_AD_CNTINF
                              WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                                AND DDL_YN = 'N'
                                AND NVL(TOTAL_ROOM_NUM, 0) > NVL(USE_ROOM_NUM, 0)
                            ) T_CNT
                    ON T_CNT.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN TB_CM_IMG T_IMG
                    ON T_IMG.LINK_NUM = T_PRDT.CORP_ID
                   AND T_IMG.IMG_SN = 1
                  LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
                    ON T_ANLS.LINK_NUM = T_PRDT.PRDT_NUM
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
               )
         WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
       )
 WHERE ROWNUM < 6
 ]]>
</select>

<!-- 패키지 새로운 상품 -->
<select id="MAIN_S_02" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
             , SAVE_PATH
     	     , SAVE_FILE_NM
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'TOUR'
                   AND T_PRDT.CTGR IN ('C120', 'C130', 'C140', 'C150')
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
          LEFT OUTER JOIN TB_CM_IMG R2
			ON S.PRDT_NUM = R2.LINK_NUM
		   AND R2.IMG_SN = 1
	     WHERE RK = 1
         ORDER BY CONF_DTTM DESC
	 ) R1
 WHERE RN < 11
 ]]>
</select>

<!-- 베스트 묶음 할인상품 부분 -->
<select id="MAIN_S_03" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'TOUR'
                   ]]>
                   AND T_PRDT.CTGR = #sCtgr#
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   <![CDATA[
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE RN < 6
 ]]>
</select>

<!-- 할인쿠폰 -->
<select id="MAIN_S_04" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT PRDT_NUM
             , CTGR
             , PRDT_DIV
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , 0 AS SP_DIV_SN
             , 0 AS SP_OPT_SN
             , 0 AS SALE_AMT
             , 0 AS NML_AMT
             , 0 AS NUM_AMT
             , 0 AS DIS_PER
             , T_IMG.SAVE_PATH
             , T_IMG.SAVE_FILE_NM
             , T_GPA.GPA_AVG
          FROM TB_SP_PRDTINF T_PRDT
         INNER JOIN TB_CM_IMG T_IMG
            ON T_IMG.LINK_NUM = T_PRDT.PRDT_NUM
           AND T_IMG.IMG_SN = 1
          LEFT OUTER JOIN TB_GPA_ANLS T_GPA
            ON T_GPA.LINK_NUM = T_PRDT.PRDT_NUM
         WHERE 1=1
           AND T_PRDT.TRADE_STATUS = 'TS03'
           AND T_PRDT.SALE_START_DT <= TO_DATE(SYSDATE, 'YYYY/MM/DD')
           AND T_PRDT.SALE_END_DT >= TO_DATE(SYSDATE, 'YYYY/MM/DD')
           AND T_PRDT.PRDT_DIV = 'FREE'
           AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
         ORDER BY DBMS_RANDOM.VALUE
       )
 WHERE ROWNUM < 6
]]>
</select>

<!-- 렌터카 -->
<select id="MAIN_S_05" resultMap="MAIN_R_01">
<![CDATA[
SELECT PRDT_NUM
     , PRDT_NM
     , CORP_ID
     , CORP_NM
     , DIS_PER
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT V_PRDT.PRDT_NUM
             , V_PRDT.PRDT_NM
             , V_PRDT.CORP_ID
             , V_PRDT.CORP_NM
             , V_PRDT.CONF_DTTM
             , V_PRDT.NML_AMT
             , V_PRDT.DIS_PER
             , TRUNC((NML_AMT * (100 - DIS_PER) / 100), -2) AS SALE_AMT
             , '' AS SIMPLE_EXP
             , T_IMG.SAVE_PATH
		     , T_IMG.SAVE_FILE_NM
             , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
          FROM (SELECT T_PRDT.CORP_ID
                     , T_CORP.CORP_NM
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.PRDT_NM
                     , T_PRDT.CONF_DTTM
                     , T_AMT.TM24_AMT AS NML_AMT
                     , (CASE WHEN TO_NUMBER(T_DFT.DIS_PER_APL_TM) > 24
                             THEN 0
                             /*주말할인율 적용여부*/
                             ELSE (CASE T_DFT.WKD_DIS_PER_APL_YN
                                   WHEN 'Y'
                                   /*입력된 예약 시작일에 대한 요일 체크*/
                                   THEN (CASE WHEN INSTR(T_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR(SYSDATE, 'D') - 1) > 0
                                              THEN T_DISPER.WKD_DIS_PER
                                              ELSE T_DISPER.WDAY_DIS_PER
                                          END
                                        )
                                   ELSE T_DISPER.WDAY_DIS_PER
                                    END
                                  )
                          END) AS DIS_PER
                  FROM TB_RC_PRDTINF T_PRDT
                 INNER JOIN TB_RC_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN TB_CORP T_CORP
                    ON T_CORP.CORP_ID = T_PRDT.CORP_ID
                   AND T_CORP.TRADE_STATUS_CD = 'TS03'
                  /*요금*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , TM6_AMT
                                  , TM12_AMT
                                  , TM24_AMT
                                  , TM1_ADD_AMT
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY (TO_CHAR(SYSDATE+1, 'YYYYMMDD') - APL_DT)) AS RK
                               FROM TB_RC_AMTINF
                            ) T_AMT
                    ON T_AMT.RK = 1
                   AND T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                   /*할인율*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , DIS_PER_NUM
                                  , APL_START_DT
                                  , APL_END_DT
                                  , WDAY_DIS_PER
                                  , WKD_DIS_PER
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY DIS_PER_NUM DESC) AS RK
                               FROM TB_RC_DISPERINF
                              WHERE APL_START_DT <= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                AND APL_END_DT   >= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                            ) T_DISPER
                    ON T_DISPER.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_DISPER.RK = 1
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
               ) V_PRDT
         INNER JOIN TB_CM_IMG T_IMG
		    ON T_IMG.LINK_NUM = V_PRDT.PRDT_NUM
		   AND T_IMG.IMG_SN   = 1
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON T_ANLS.LINK_NUM = V_PRDT.PRDT_NUM
         ORDER BY DIS_PER DESC
                , SALE_AMT ASC
       )
 WHERE ROWNUM < 11
 ]]>
</select>

<!-- 관광지 입장권 -->
<select id="MAIN_S_06" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND T_PRDT.CTGR IN ('C210', 'C220', 'C230', 'C240')
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE RN < 11
 ]]>
</select>

<!-- 숙박 랜덤 -->
<select id="MAIN_S_07" resultMap="MAIN_R_01">
<![CDATA[
SELECT CORP_ID
     , PRDT_NUM
     , PRDT_NM
     , CORP_NM
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT CORP_ID
             , PRDT_NUM
             , PRDT_NM
             , CORP_NM
             , NML_AMT
             , SALE_AMT
             , SIMPLE_EXP
             , DIS_PER
             , SAVE_PATH
             , SAVE_FILE_NM
             , GPA_AVG
          FROM (SELECT V_PRDT.CORP_ID
                     , V_PRDT.PRDT_NUM
                     , V_PRDT.PRDT_NM
                     , V_PRDT.CORP_NM
                     , V_PRDT.NML_AMT
                     , V_PRDT.SALE_AMT
                     , V_PRDT.SIMPLE_EXP
                     , CASE WHEN V_PRDT.NML_AMT != 0 THEN 100 - (TRUNC(V_PRDT.SALE_AMT / V_PRDT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_IMG.SAVE_PATH
                     , T_IMG.SAVE_FILE_NM
                     , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
                     , ROW_NUMBER() OVER(PARTITION BY V_PRDT.CORP_ID ORDER BY V_PRDT.SALE_AMT ASC, V_PRDT.PRDT_NUM) AS RK
                  FROM (SELECT T_DFT.CORP_ID
                             , T_PRDT.PRDT_NUM
                             , T_PRDT.PRDT_NM
                             , T_DFT.AD_NM          AS CORP_NM
                             , T_AMT.NML_AMT
                             , (CASE WHEN DAYPRICE_YN = 'Y' AND DAYPRICE_AMT > 0 THEN DAYPRICE_AMT
                                     ELSE SALE_AMT
                                 END
                               ) AS SALE_AMT
                             , T_DFT.AD_SIMPLE_EXP  AS SIMPLE_EXP
                          FROM TB_AD_PRDTINF T_PRDT
                         INNER JOIN TB_AD_DFTINF T_DFT
                            ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                         INNER JOIN (SELECT PRDT_NUM
                                          , APL_DT
                                          , SALE_AMT
                                          , NML_AMT
                                          , DAYPRICE_YN
                                          , DAYPRICE_AMT
                                       FROM TB_AD_AMTINF
                                      WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                                    ) T_AMT
                            ON T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                         INNER JOIN (SELECT PRDT_NUM
                                          , APL_DT
                                          , TOTAL_ROOM_NUM
                                          , USE_ROOM_NUM
                                          , DDL_YN
                                       FROM TB_AD_CNTINF
                                      WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                                    ) T_CNT
                            ON T_CNT.PRDT_NUM = T_PRDT.PRDT_NUM
                         WHERE T_PRDT.TRADE_STATUS = 'TS03'
                           AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                       ) V_PRDT
                 INNER JOIN TB_CM_IMG T_IMG
                    ON T_IMG.LINK_NUM = V_PRDT.CORP_ID
                   AND T_IMG.IMG_SN = 1
                  LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
                    ON T_ANLS.LINK_NUM = V_PRDT.PRDT_NUM
               )
         WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
       )
 WHERE ROWNUM < 11
 ]]>
</select>

<select id="MAIN_S_10" resultMap="MAIN_R_10">
SELECT PRDT_NUM
    , CORP_ID
    , CORP_NM
    , (PRDT_NM || ' / ' || (SELECT CD_NM FROM TB_CD WHERE CD_NUM = USE_FUEL_DIV)) AS PRDT_NM
    , (CASE WHEN APPROX_NML_AMT IS NOT NULL THEN APPROX_NML_AMT ELSE NML_AMT END) AS NML_AMT
    , (CASE WHEN APPROX_NML_AMT IS NOT NULL AND APPROX_SALE_AMT IS NOT NULL  THEN ROUND((1-(APPROX_SALE_AMT/APPROX_NML_AMT))*100,0) ELSE DIS_PER END) AS DIS_PER
    , (CASE WHEN APPROX_SALE_AMT IS NOT NULL THEN APPROX_SALE_AMT ELSE TRUNC ( (NML_AMT * (100 - DIS_PER) / 100), - 2) END) AS SALE_AMT
    , SAVE_FILE_NM
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
            INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
                AND PRM.PRMT_DIV = 'EVNT'
                AND PRM.STATUS_CD = 'TS03'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
    WHERE PRM_PRD.PRDT_NUM = RC.PRDT_NUM
        AND PRM.CORP_ID = RC.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = RC.PRDT_NUM) AS COUPON_CNT
FROM (SELECT RC_PRD.PRDT_NUM
        , CORP.CORP_ID
        , CORP.CORP_NM
        , RC_PRD.PRDT_NM
        , RC_PRD.USE_FUEL_DIV
        , RC_AMT.TM24_AMT AS NML_AMT
        , (CASE
                WHEN TO_NUMBER (RC_DFT.DIS_PER_APL_TM) > 24 THEN 0
                ELSE (CASE RC_DFT.WKD_DIS_PER_APL_YN
                            WHEN 'Y' THEN (CASE
                                                WHEN INSTR (RC_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR (SYSDATE + 1, 'D') - 1) > 0 THEN RC_DIS.WKD_DIS_PER
                                                ELSE RC_DIS.WDAY_DIS_PER
                                            END)
                            ELSE RC_DIS.WDAY_DIS_PER
                        END)
            END) AS DIS_PER
        , NVL ((CASE
                    WHEN (RC_PRD.LINK_MAPPING_NUM IS NOT NULL AND CORP.CORP_LINK_YN = 'Y') THEN 1
                    ELSE (SELECT TOTAL_CAR_NUM FROM TB_RC_CNTINF WHERE PRDT_NUM = RC_PRD.PRDT_NUM AND APL_DT = TO_CHAR (SYSDATE + 1, 'YYYYMMDD'))
            END), 1) AS ABLE_CNT
        , RC_PRD.LINK_MAPPING_NUM
        , CORP.CORP_LINK_YN
        , RC_CAR.CAR_IMG AS SAVE_FILE_NM
        , RANK() OVER (PARTITION BY RC_PRD.CORP_ID ORDER BY RC_PRD.CORP_RAND_LEVEL DESC, RC_AMT.APL_DT DESC, RC_DIS.DIS_PER_NUM DESC) AS RK
        , APPROX_NML_AMT
        , APPROX_SALE_AMT
    FROM TB_RC_PRDTINF RC_PRD
        INNER JOIN TB_CORP CORP               ON CORP.CORP_ID = RC_PRD.CORP_ID
            AND CORP.TRADE_STATUS_CD = 'TS03'
        INNER JOIN TB_RC_CARDIV RC_CAR        ON RC_CAR.RC_CARDIV_NUM = RC_PRD.RC_CARDIV_NUM
            AND RC_CAR.USE_YN = 'Y'
        INNER JOIN TB_RC_DFTINF RC_DFT        ON RC_DFT.CORP_ID = CORP.CORP_ID
        INNER JOIN TB_RC_DISPERINF RC_DIS     ON RC_DIS.PRDT_NUM = RC_PRD.PRDT_NUM
            AND TO_CHAR (SYSDATE + 1, 'YYYYMMDD') BETWEEN RC_DIS.APL_START_DT AND RC_DIS.APL_END_DT
        INNER JOIN TB_RC_AMTINF RC_AMT        ON RC_AMT.PRDT_NUM = RC_PRD.PRDT_NUM
        LEFT OUTER JOIN TB_MAIN_CTGR_RCMD MCR ON MCR.PRDT_NUM = RC_PRD.PRDT_NUM
            AND MCR.PRDT_DIV = 'RC'
    WHERE RC_PRD.TRADE_STATUS = 'TS03'
    ORDER BY RC_PRD.CORP_RAND_LEVEL DESC) RC
WHERE RK = 1
    AND ABLE_CNT > 0
    <isNotEmpty property="sNum">
        <![CDATA[
        AND ROWNUM <= TO_NUMBER(#sNum#)
        ]]>
    </isNotEmpty>
</select>

<!-- 숙박할인율랭킹 -->
<!-- 2016.03.22 할인율 -> 랜덤으로 변경(김기현실장요청)
	 2016.03.30 다인 리조트가 가장 먼저 나오게 처리(김기현실장요청)
	 2016.07.01 협회장 요청 보오메꾸뜨르(1순위), 다인 리조트(2순위) 처리
	 2016.10.26 다인, 보오메꾸 해제
	 2017.08.16 현재일 기준 최저가 객실 대상 마감이면 노출 제외
	 -->
<select id="MAIN_S_11" resultMap="MAIN_R_11">
SELECT CORP_ID
    , PRDT_NUM
    , PRDT_NM
    , CORP_NM
    , NML_AMT
    , SALE_AMT
    , SIMPLE_EXP
    , DIS_PER
    , SAVE_PATH
    , SAVE_FILE_NM
    , GPA_AVG
    , DAYPRICE_YN
    , AD_AREA_NM
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
            INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
                AND PRM.PRMT_DIV = 'EVNT'
                AND PRM.STATUS_CD = 'TS03'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
        WHERE PRM_PRD.PRDT_NUM = AD2.PRDT_NUM
            AND PRM.CORP_ID = AD2.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = AD2.PRDT_NUM) AS COUPON_CNT
    , TAMNACARD_YN
FROM (SELECT CORP_ID
            , PRDT_NUM
            , PRDT_NM
            , CORP_NM
            , NML_AMT
            , SALE_AMT
            , SIMPLE_EXP
            , (100 - (TRUNC (SALE_AMT / NML_AMT, 2) * 100)) AS DIS_PER
            , SAVE_PATH
            , SAVE_FILE_NM
            , (SELECT GPA_AVG FROM TB_GPA_ANLS WHERE LINK_NUM = AD.CORP_ID) AS GPA_AVG
            , DAYPRICE_YN
            , (SELECT CD_NM FROM TB_CD WHERE HRK_CD_NUM = 'ADAR' AND CD_NUM = AD.AD_AREA) AS AD_AREA_NM
            , (SELECT CORP_LEVEL - NVL (COMPLAIN_LEVEL, 0) + NVL (JOIN_LEVEL, 0) + NVL (AMT_LEVEL, 0)
                FROM TB_CORP_LEVEL
                WHERE CORP_ID = AD.CORP_ID) AS CORP_LEVEL
            , FRST_REG_DTTM
            , TAMNACARD_YN
        FROM (SELECT AD_DFT.CORP_ID
                , AD_PRD.PRDT_NUM
                , AD_PRD.PRDT_NM
                , AD_DFT.AD_NM AS CORP_NM
                , AD_AMT.NML_AMT
                , DECODE (AD_AMT.DAYPRICE_YN, 'Y', AD_AMT.DAYPRICE_AMT, AD_AMT.SALE_AMT) AS SALE_AMT
                , AD_DFT.AD_SIMPLE_EXP AS SIMPLE_EXP
                , CM_IMG.SAVE_PATH
                , CM_IMG.SAVE_FILE_NM
                , AD_AMT.DAYPRICE_YN
                , AD_DFT.AD_AREA
                , ROW_NUMBER() OVER (PARTITION BY AD_DFT.CORP_ID ORDER BY DECODE (AD_AMT.DAYPRICE_YN, 'Y', AD_AMT.DAYPRICE_AMT, AD_AMT.SALE_AMT)) AS RK
                , CORP.FRST_REG_DTTM
                , CASE WHEN CORP.TAMNACARD_MNG_YN = 'C' OR (CORP.TAMNACARD_MNG_YN = 'P' AND AD_PRD.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
            FROM TB_AD_PRDTINF AD_PRD
                INNER JOIN TB_AD_DFTINF AD_DFT        ON AD_DFT.CORP_ID = AD_PRD.CORP_ID
                INNER JOIN TB_CORP CORP               ON CORP.CORP_ID = AD_DFT.CORP_ID
                    AND CORP.TRADE_STATUS_CD = 'TS03'
                INNER JOIN TB_AD_AMTINF AD_AMT        ON AD_AMT.PRDT_NUM = AD_PRD.PRDT_NUM
                    AND AD_AMT.APL_DT = TO_CHAR (SYSDATE, 'YYYYMMDD')
                    AND NVL(AD_AMT.SALE_AMT,0) > 0
                    AND NVL(AD_AMT.NML_AMT,0) > 0
                INNER JOIN TB_AD_CNTINF AD_CNT        ON AD_CNT.PRDT_NUM = AD_PRD.PRDT_NUM
                    AND AD_CNT.APL_DT = TO_CHAR (SYSDATE, 'YYYYMMDD')
                    AND AD_CNT.DDL_YN = 'N'
                INNER JOIN TB_CM_IMG CM_IMG           ON CM_IMG.LINK_NUM = AD_DFT.CORP_ID
                    AND CM_IMG.IMG_SN = 1
            WHERE AD_PRD.TRADE_STATUS = 'TS03'
                AND AD_PRD.PRDT_NUM NOT IN (SELECT PRDT_NUM FROM TB_MAIN_CTGR_RCMD WHERE PRDT_DIV = 'AD')) AD
    WHERE RK = 1
    ORDER BY FRST_REG_DTTM DESC) AD2
WHERE 1 = 1
    <isNotEmpty property="sNum">
        <![CDATA[
        AND ROWNUM <= TO_NUMBER(#sNum#)
        ]]>
    </isNotEmpty>
</select>

<!-- 렌터카 조회 -->
<select id="MAIN_S_12" resultMap="MAIN_R_01">
<![CDATA[
WITH T_ABLE AS (
  SELECT PRDT_NUM, (
           CASE
             WHEN (SELECT LINK_YN
                FROM TB_API
                WHERE CORP_ID = V_PRDT2.CORP_ID) = 'Y' THEN DECODE(V_PRDT2.PRDT_LINK_YN, 'Y', 'N', ABLE_YN)
             ELSE ABLE_YN
           END ) AS ABLE_YN
         FROM (SELECT T_CORP.CORP_ID, T_PRDT1.PRDT_NUM, PRDT_LINK_YN, (
           CASE
             WHEN RSV_TM < TO_NUMBER(T_DFT.RSV_ABLE_MINI_TM) THEN 'N'
             ELSE (
               CASE
                 WHEN RSV_MAXI_TM_APL_YN = 'Y' THEN (
                   CASE
                     WHEN RSV_TM > RSV_MAXI_TM THEN 'N'
                     ELSE (
                       CASE /*당일예약불가 체크*/
                         WHEN (T_DFT.DAY_RSV_UNABLE_YN = 'Y' )
                           THEN (
                             CASE
                               WHEN TO_CHAR(SYSDATE, 'HH24') < DAY_RSV_UNABLE_TM THEN T_ABLE.ABLE_YN
                               ELSE 'N'
                           END)
                         ELSE T_ABLE.ABLE_YN
                       END )
                   END)
                 ELSE (
                   CASE /*당일예약불가 체크*/
                     WHEN (T_DFT.DAY_RSV_UNABLE_YN = 'Y' )
                     THEN (
                       CASE
                         WHEN TO_CHAR(SYSDATE, 'HH24') < DAY_RSV_UNABLE_TM THEN T_ABLE.ABLE_YN
                         ELSE 'N'
                       END)
                     ELSE T_ABLE.ABLE_YN
                   END )
                 END )
               END) AS ABLE_YN
             FROM TB_RC_PRDTINF T_PRDT1
               INNER JOIN TB_CORP T_CORP ON T_CORP.CORP_ID = T_PRDT1.CORP_ID AND T_CORP.CORP_CD = 'RC' AND T_CORP.TRADE_STATUS_CD = 'TS03' /*렌터카회사-조회조건*/
               INNER JOIN (
                    SELECT PRDT_NUM , DECODE(SUM(DISABLE_CNT), 0 , 'Y', 'N') AS ABLE_YN
                      FROM (
                        SELECT T_ABLE.PRDT_NUM /*상품번호*/,
                                   DT /*예약일*/,
                                   DTTM /*체크시간*/,
                                       CASE
                                         WHEN TOTAL_CAR_NUM - NVL(USE_CNT, 0) < 1 THEN 1
                                         ELSE 0
                                       END AS DISABLE_CNT /*불가능여부(1이면 불가능)*/
                              FROM (
                                    SELECT PRDT_NUM /*상품번호*/,
                                               DT /*예약일*/,
                                               TOTAL_CAR_NUM /*차량보유대수*/ /*(예약일자별 * 상품별)의 차량보유대수*/
                                  FROM (
                                    SELECT T_PRDT1.PRDT_NUM ,
                                               DT ,
                                               NVL(TOTAL_CAR_NUM, 0) AS TOTAL_CAR_NUM ,
                                               ROW_NUMBER() OVER(PARTITION BY T_PRDT1.PRDT_NUM, DT
                                                 ORDER BY (DT - APL_DT)) AS RK
                                          FROM (
                                            SELECT PRDT_NUM ,
                                                       DT
                                                  FROM (SELECT TO_CHAR(TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') + (LEVEL-1), 'YYYYMMDD') AS DT
                                                          FROM DUAL CONNECT BY LEVEL <= TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') + 1 ),
                                                       TB_RC_PRDTINF ) T_PRDT1
                                             LEFT OUTER JOIN TB_RC_CNTINF T_CNTINF ON T_CNTINF.PRDT_NUM = T_PRDT1.PRDT_NUM AND T_CNTINF.APL_DT <= T_PRDT1.DT
                                          )
                             WHERE RK = 1 ) T_ABLE /*예약현황 체크 조인*/
                             LEFT OUTER JOIN (SELECT PRDT_NUM /*예약상품번호*/, DTTM /*사용일시*/, COUNT(*) AS USE_CNT /*사용건수*/
                              FROM (SELECT PRDT_NUM ,
                                           DTTM
                                      FROM (SELECT *
                                              FROM TB_RC_USEHIST
                                             WHERE USE_DT BETWEEN TO_CHAR(SYSDATE, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')) T_USEHIST INNER JOIN (SELECT TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI') + ((LEVEL -1) / 24) AS DTTM
                                              FROM DUAL CONNECT BY LEVEL <= ROUND(TO_DATE(TO_CHAR(SYSDATE+1, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI')) * 24 ) T_DTTM ON T_DTTM.DTTM BETWEEN TO_DATE(USE_DT||START_TM, 'YYYYMMDDHH24MI') AND TO_DATE(USE_DT||END_TM, 'YYYYMMDDHH24MI') )
                             GROUP BY PRDT_NUM , DTTM ) AS T_USEABLE ON T_USEABLE.PRDT_NUM = T_ABLE.PRDT_NUM
                       AND TO_CHAR(T_USEABLE.DTTM, 'YYYYMMDD') = T_ABLE.DT )
             GROUP BY PRDT_NUM ) T_ABLE ON T_ABLE.PRDT_NUM = T_PRDT1.PRDT_NUM /*AND T_ABLE.ABLE_YN = 'Y'*/ /*기본정보+기준시간*/
           INNER JOIN (SELECT
                  CORP_ID , RSV_ABLE_MINI_TM , RSV_TM , DAY_RSV_UNABLE_YN , RSV_MAXI_TM_APL_YN, RSV_MAXI_TM, DAY_RSV_UNABLE_TM
                    FROM TB_RC_DFTINF , (SELECT RSV_TM
                                FROM (SELECT ROUND((TO_DATE(TO_CHAR(SYSDATE+1, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI')) * 24) AS RSV_TM
                        FROM DUAL ) ) /*입력된 날짜에 대한 필요 변수*/) T_DFT ON T_DFT.CORP_ID = T_CORP.CORP_ID /*요금*/
                 WHERE 1=1
                   AND T_PRDT1.TRADE_STATUS = 'TS03'
				   AND T_PRDT1.CAR_DIV = #sCarDiv#
                   ) V_PRDT2
)
]]>

<![CDATA[
SELECT PRDT_NUM
     , PRDT_NM
     , CORP_ID
     , CORP_NM
     , DIS_PER
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT V_PRDT.PRDT_NUM
             , V_PRDT.PRDT_NM
             , V_PRDT.CORP_ID
             , V_PRDT.CORP_NM
             , V_PRDT.CONF_DTTM
             , V_PRDT.NML_AMT
             , V_PRDT.DIS_PER
             , TRUNC((NML_AMT * (100 - DIS_PER) / 100), -2) AS SALE_AMT
             , '' AS SIMPLE_EXP
             , T_IMG.SAVE_PATH
		     , T_IMG.SAVE_FILE_NM
             , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
             , (SELECT ABLE_YN FROM T_ABLE T_AB WHERE T_AB.PRDT_NUM=V_PRDT.PRDT_NUM) AS ABLE_YN
          FROM (SELECT T_PRDT.CORP_ID
                     , T_CORP.CORP_NM
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.PRDT_NM
                     , T_PRDT.CONF_DTTM
                     , T_AMT.TM24_AMT AS NML_AMT
                     , (CASE WHEN TO_NUMBER(T_DFT.DIS_PER_APL_TM) > 24
                             THEN 0
                             /*주말할인율 적용여부*/
                             ELSE (CASE T_DFT.WKD_DIS_PER_APL_YN
                                   WHEN 'Y'
                                   /*입력된 예약 시작일에 대한 요일 체크*/
                                   THEN (CASE WHEN INSTR(T_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR(SYSDATE, 'D') - 1) > 0
                                              THEN T_DISPER.WKD_DIS_PER
                                              ELSE T_DISPER.WDAY_DIS_PER
                                          END
                                        )
                                   ELSE T_DISPER.WDAY_DIS_PER
                                    END
                                  )
                          END) AS DIS_PER
                  FROM TB_RC_PRDTINF T_PRDT
                 INNER JOIN TB_RC_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN TB_CORP T_CORP
                    ON T_CORP.CORP_ID = T_PRDT.CORP_ID
                   AND T_CORP.TRADE_STATUS_CD = 'TS03'
                  /*요금*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , TM6_AMT
                                  , TM12_AMT
                                  , TM24_AMT
                                  , TM1_ADD_AMT
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY (TO_CHAR(SYSDATE+1, 'YYYYMMDD') - APL_DT)) AS RK
                               FROM TB_RC_AMTINF
                            ) T_AMT
                    ON T_AMT.RK = 1
                   AND T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                   /*할인율*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , DIS_PER_NUM
                                  , APL_START_DT
                                  , APL_END_DT
                                  , WDAY_DIS_PER
                                  , WKD_DIS_PER
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY DIS_PER_NUM DESC) AS RK
                               FROM TB_RC_DISPERINF
                              WHERE APL_START_DT <= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                AND APL_END_DT   >= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                            ) T_DISPER
                    ON T_DISPER.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_DISPER.RK = 1
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
                 ]]>
                 <isNotEmpty property="sCarDiv">
				   AND T_PRDT.CAR_DIV = #sCarDiv#
				 </isNotEmpty>
				<![CDATA[
               ) V_PRDT
         INNER JOIN TB_CM_IMG T_IMG
		    ON T_IMG.LINK_NUM = V_PRDT.PRDT_NUM
		   AND T_IMG.IMG_SN   = 1
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON T_ANLS.LINK_NUM = V_PRDT.PRDT_NUM
         ORDER BY ABLE_YN DESC
         		, DIS_PER DESC
                , SALE_AMT ASC
                , DBMS_RANDOM.VALUE
       )
 WHERE ROWNUM < TO_NUMBER(#sNum#) + 1
 ]]>
</select>

<!-- 베스트 묶음 할인상품 부분 -->
<select id="MAIN_S_13" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'TOUR'
                   ]]>
                   AND T_PRDT.CTGR = #sCtgr#
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   <![CDATA[
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 4
 ]]>
</select>

<!-- 관광지 입장권 -->
<select id="MAIN_S_14" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
             , (SELECT CORP_LEVEL - NVL(COMPLAIN_LEVEL,0) + NVL(JOIN_LEVEL,0) + NVL(AMT_LEVEL,0)
				      FROM TB_CORP_LEVEL
				      WHERE CORP_CD='SP'
				      	AND CORP_ID=S.CORP_ID
				) AS CORP_LEVEL
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , CASE WHEN T_PRDT.PRDT_DIV = 'TOUR'
                                 THEN  ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC )
                              WHEN T_PRDT.PRDT_DIV != 'TOUR'
                                 THEN ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_DIV.VIEW_SN ASC, T_OPT.VIEW_SN ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC )
                       END AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_DIVINF T_DIV
	  	 			  ON T_DIV.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C2'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   AND T_PRDT.PRDT_NUM NOT IN (
			       	 SELECT PRDT_NUM FROM TB_MAIN_CTGR_RCMD
			       	 	WHERE PRINT_SN <= 7
			       )
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
         WHERE RK = 1
         ORDER BY CORP_LEVEL DESC, CORP_ID
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < TO_NUMBER(#sNum#) + 1
 ]]>
</select>

<!-- 레저 -->
<select id="MAIN_S_15" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND T_PRDT.CTGR IN ('C320', 'C330', 'C340')
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 5
 ]]>
</select>

<!-- 음식뷰티기타 -->
<select id="MAIN_S_16" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
             , (SELECT CORP_LEVEL - NVL(COMPLAIN_LEVEL,0) + NVL(JOIN_LEVEL,0) + NVL(AMT_LEVEL,0)
				      FROM TB_CORP_LEVEL
				      WHERE CORP_CD='SP'
				      	AND CORP_ID=S.CORP_ID
				) AS CORP_LEVEL
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , CASE WHEN T_PRDT.PRDT_DIV = 'TOUR'
                                 THEN  ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC )
                              WHEN T_PRDT.PRDT_DIV != 'TOUR'
                                 THEN ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY  T_DIV.VIEW_SN ASC, T_OPT.VIEW_SN ASC )
                       END AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_DIVINF T_DIV
	  	 			  ON T_DIV.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C3'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   AND T_PRDT.PRDT_NUM NOT IN (
			       	 SELECT PRDT_NUM FROM TB_MAIN_CTGR_RCMD
			       	 	WHERE PRINT_SN <= 7
			       )
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY CORP_LEVEL DESC, CORP_ID
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < TO_NUMBER(#sNum#) + 1
 ]]>
</select>

<!-- 패키지 할인상품 부분 -->
<select id="MAIN_S_17" resultMap="MAIN_R_02">
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
             , (SELECT CORP_LEVEL - NVL(COMPLAIN_LEVEL,0) + NVL(JOIN_LEVEL,0) + NVL(AMT_LEVEL,0)
				      FROM TB_CORP_LEVEL
				      WHERE CORP_ID=S.CORP_ID
				) AS CORP_LEVEL
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , NVL(T_PRDT.PRDT_INF, ' ') AS PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'

                   <isNotEmpty property="sCtgr">
						<isEqual property="sCtgr" compareValue="C180">
				   AND ((T_PRDT.PRDT_DIV='TOUR' AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')) OR (T_PRDT.PRDT_DIV='COUP' AND T_OPT.APL_DT IS NULL))
				   		</isEqual>
				   		<isNotEqual property="sCtgr" compareValue="C180">
				   <![CDATA[
                   AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   ]]>
				   		</isNotEqual>
					</isNotEmpty>
                   <isEmpty property="sCtgr">
                   <![CDATA[
                   /*AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   ]]>
					</isEmpty>
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   <![CDATA[
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   ]]>

                   <isNotEmpty property="sCtgr">
						<isEqual property="sCtgr" compareValue="C180">
				   AND T_PRDT.PRDT_DIV IN ('TOUR', 'COUP')
				   		</isEqual>
				   		<isNotEqual property="sCtgr" compareValue="C180">
				   AND T_PRDT.PRDT_DIV='TOUR'
				   		</isNotEqual>
				   AND T_PRDT.CTGR = #sCtgr#
					</isNotEmpty>
                   <isEmpty property="sCtgr">
                   AND T_PRDT.PRDT_DIV IN ('TOUR', 'COUP')
				   <!-- AND T_PRDT.CTGR IN ('C120', 'C130', 'C140', 'C150', 'C180') -->
				   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C1'
					</isEmpty>
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   AND T_PRDT.PRDT_NUM NOT IN (
			       	 SELECT PRDT_NUM FROM TB_MAIN_CTGR_RCMD
			       	   <![CDATA[
			       	 	WHERE PRINT_SN <= 8
			       	   ]]>
			       )
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY CORP_LEVEL DESC, CORP_ID
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 <![CDATA[
 WHERE ROWNUM < TO_NUMBER(#sNum#) + 1
 ]]>
</select>

<!-- 골프패키지 할인상품 부분 -->
<select id="MAIN_S_18" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , NVL(T_PRDT.PRDT_INF, ' ') AS PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'TOUR'
                   ]]>
				   AND T_PRDT.CTGR = 'C170'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   <![CDATA[
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 5
 ]]>
</select>

<!-- 버스관광 할인상품 부분 -->
<select id="MAIN_S_19" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , NVL(T_PRDT.PRDT_INF, ' ') AS PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'TOUR'
                   ]]>
				   AND T_PRDT.CTGR = 'C160'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   <![CDATA[
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 7
 ]]>
</select>

<!-- 2016.10.18 추가
	렌터카 중소형 2개, 고급 3개, suv 3개, 수입 스포츠 2개
	업체 지수예 따른 추출 (2017-12-30, By JDongS)
 -->
<select id="MAIN_S_20" resultMap="MAIN_R_01">
<![CDATA[
WITH T_ABLE AS (
  SELECT PRDT_NUM, (
           CASE
             WHEN (SELECT LINK_YN
                FROM TB_API
                WHERE CORP_ID = V_PRDT2.CORP_ID) = 'Y' THEN DECODE(V_PRDT2.PRDT_LINK_YN, 'Y', 'N', ABLE_YN)
             ELSE ABLE_YN
           END ) AS ABLE_YN
         FROM (SELECT T_CORP.CORP_ID, T_PRDT1.PRDT_NUM, PRDT_LINK_YN, (
           CASE
             WHEN RSV_TM < TO_NUMBER(T_DFT.RSV_ABLE_MINI_TM) THEN 'N'
             ELSE (
               CASE
                 WHEN RSV_MAXI_TM_APL_YN = 'Y' THEN (
                   CASE
                     WHEN RSV_TM > RSV_MAXI_TM THEN 'N'
                     ELSE (
                       CASE /*당일예약불가 체크*/
                         WHEN (T_DFT.DAY_RSV_UNABLE_YN = 'Y' )
                           THEN (
                             CASE
                               WHEN TO_CHAR(SYSDATE, 'HH24') < DAY_RSV_UNABLE_TM THEN T_ABLE.ABLE_YN
                               ELSE 'N'
                           END)
                         ELSE T_ABLE.ABLE_YN
                       END )
                   END)
                 ELSE (
                   CASE /*당일예약불가 체크*/
                     WHEN (T_DFT.DAY_RSV_UNABLE_YN = 'Y' )
                     THEN (
                       CASE
                         WHEN TO_CHAR(SYSDATE, 'HH24') < DAY_RSV_UNABLE_TM THEN T_ABLE.ABLE_YN
                         ELSE 'N'
                       END)
                     ELSE T_ABLE.ABLE_YN
                   END )
                 END )
               END) AS ABLE_YN
             FROM TB_RC_PRDTINF T_PRDT1
               INNER JOIN TB_CORP T_CORP ON T_CORP.CORP_ID = T_PRDT1.CORP_ID AND T_CORP.CORP_CD = 'RC' AND T_CORP.TRADE_STATUS_CD = 'TS03' /*렌터카회사-조회조건*/
               INNER JOIN (
                    SELECT PRDT_NUM , DECODE(SUM(DISABLE_CNT), 0 , 'Y', 'N') AS ABLE_YN
                      FROM (
                        SELECT T_ABLE.PRDT_NUM /*상품번호*/,
                                   DT /*예약일*/,
                                   DTTM /*체크시간*/,
                                       CASE
                                         WHEN TOTAL_CAR_NUM - NVL(USE_CNT, 0) < 1 THEN 1
                                         ELSE 0
                                       END AS DISABLE_CNT /*불가능여부(1이면 불가능)*/
                              FROM (
                                    SELECT PRDT_NUM /*상품번호*/,
                                               DT /*예약일*/,
                                               TOTAL_CAR_NUM /*차량보유대수*/ /*(예약일자별 * 상품별)의 차량보유대수*/
                                  FROM (
                                    SELECT T_PRDT1.PRDT_NUM ,
                                               DT ,
                                               NVL(TOTAL_CAR_NUM, 0) AS TOTAL_CAR_NUM ,
                                               ROW_NUMBER() OVER(PARTITION BY T_PRDT1.PRDT_NUM, DT
                                                 ORDER BY (DT - APL_DT)) AS RK
                                          FROM (
                                            SELECT PRDT_NUM ,
                                                       DT
                                                  FROM (SELECT TO_CHAR(TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') + (LEVEL-1), 'YYYYMMDD') AS DT
                                                          FROM DUAL CONNECT BY LEVEL <= TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') + 1 ),
                                                       TB_RC_PRDTINF ) T_PRDT1
                                             LEFT OUTER JOIN TB_RC_CNTINF T_CNTINF ON T_CNTINF.PRDT_NUM = T_PRDT1.PRDT_NUM AND T_CNTINF.APL_DT <= T_PRDT1.DT
                                          )
                             WHERE RK = 1 ) T_ABLE /*예약현황 체크 조인*/
                             LEFT OUTER JOIN (SELECT PRDT_NUM /*예약상품번호*/, DTTM /*사용일시*/, COUNT(*) AS USE_CNT /*사용건수*/
                              FROM (SELECT PRDT_NUM ,
                                           DTTM
                                      FROM (SELECT *
                                              FROM TB_RC_USEHIST
                                             WHERE USE_DT BETWEEN TO_CHAR(SYSDATE, 'YYYYMMDD') AND TO_CHAR(SYSDATE, 'YYYYMMDD')) T_USEHIST INNER JOIN (SELECT TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI') + ((LEVEL -1) / 24) AS DTTM
                                              FROM DUAL CONNECT BY LEVEL <= ROUND(TO_DATE(TO_CHAR(SYSDATE+1, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI')) * 24 ) T_DTTM ON T_DTTM.DTTM BETWEEN TO_DATE(USE_DT||START_TM, 'YYYYMMDDHH24MI') AND TO_DATE(USE_DT||END_TM, 'YYYYMMDDHH24MI') )
                             GROUP BY PRDT_NUM , DTTM ) AS T_USEABLE ON T_USEABLE.PRDT_NUM = T_ABLE.PRDT_NUM
                       AND TO_CHAR(T_USEABLE.DTTM, 'YYYYMMDD') = T_ABLE.DT )
             GROUP BY PRDT_NUM ) T_ABLE ON T_ABLE.PRDT_NUM = T_PRDT1.PRDT_NUM /*AND T_ABLE.ABLE_YN = 'Y'*/ /*기본정보+기준시간*/
           INNER JOIN (SELECT
                  CORP_ID , RSV_ABLE_MINI_TM , RSV_TM , DAY_RSV_UNABLE_YN , RSV_MAXI_TM_APL_YN, RSV_MAXI_TM, DAY_RSV_UNABLE_TM
                    FROM TB_RC_DFTINF , (SELECT RSV_TM
                                FROM (SELECT ROUND((TO_DATE(TO_CHAR(SYSDATE+1, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI') - TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD') || '0900', 'YYYYMMDDHH24MI')) * 24) AS RSV_TM
                        FROM DUAL ) ) /*입력된 날짜에 대한 필요 변수*/) T_DFT ON T_DFT.CORP_ID = T_CORP.CORP_ID /*요금*/
                 WHERE 1=1
                   AND T_PRDT1.TRADE_STATUS = 'TS03') V_PRDT2
)
]]>

<![CDATA[
SELECT PRDT_NUM
     , PRDT_NM
     , CORP_ID
     , CORP_NM
     , DIS_PER
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT V_PRDT.PRDT_NUM
             , V_PRDT.PRDT_NM
             , V_PRDT.CORP_ID
             , V_PRDT.CORP_NM
             , V_PRDT.CONF_DTTM
             , V_PRDT.NML_AMT
             , V_PRDT.DIS_PER
             , V_PRDT.CAR_DIV
             , TRUNC((NML_AMT * (100 - DIS_PER) / 100), -2) AS SALE_AMT
             , '' AS SIMPLE_EXP
             , T_IMG.SAVE_PATH
		     , T_IMG.SAVE_FILE_NM
             , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
             , ROW_NUMBER() OVER(PARTITION BY V_PRDT.CAR_DIV ORDER BY V_PRDT.DIS_PER DESC, TRUNC((NML_AMT * (100 - DIS_PER) / 100), -2) ASC, DBMS_RANDOM.VALUE) AS RK
             , V_PRDT.ABLE_YN
             , (SELECT CORP_LEVEL - NVL(COMPLAIN_LEVEL,0) + NVL(JOIN_LEVEL,0) + NVL(AMT_LEVEL,0)
				      FROM TB_CORP_LEVEL
				      WHERE CORP_CD='RC'
				      	AND CORP_ID=V_PRDT.CORP_ID
				) AS CORP_LEVEL
          FROM (SELECT T_PRDT.CORP_ID
                     , T_CORP.CORP_NM
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.CAR_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.CONF_DTTM
                     , T_AMT.TM24_AMT AS NML_AMT
                     , (CASE WHEN TO_NUMBER(T_DFT.DIS_PER_APL_TM) > 24
                             THEN 0
                             /*주말할인율 적용여부*/
                             ELSE (CASE T_DFT.WKD_DIS_PER_APL_YN
                                   WHEN 'Y'
                                   /*입력된 예약 시작일에 대한 요일 체크*/
                                   THEN (CASE WHEN INSTR(T_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR(SYSDATE, 'D') - 1) > 0
                                              THEN T_DISPER.WKD_DIS_PER
                                              ELSE T_DISPER.WDAY_DIS_PER
                                          END
                                        )
                                   ELSE T_DISPER.WDAY_DIS_PER
                                    END
                                  )
                          END) AS DIS_PER
                      , (SELECT ABLE_YN FROM T_ABLE T_AB WHERE T_AB.PRDT_NUM=T_PRDT.PRDT_NUM) AS ABLE_YN
                  FROM TB_RC_PRDTINF T_PRDT
                 INNER JOIN TB_RC_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN TB_CORP T_CORP
                    ON T_CORP.CORP_ID = T_PRDT.CORP_ID
                   AND T_CORP.TRADE_STATUS_CD = 'TS03'
                  /*요금*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , TM6_AMT
                                  , TM12_AMT
                                  , TM24_AMT
                                  , TM1_ADD_AMT
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY (TO_CHAR(SYSDATE+1, 'YYYYMMDD') - APL_DT)) AS RK
                               FROM TB_RC_AMTINF
                            ) T_AMT
                    ON T_AMT.RK = 1
                   AND T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                   /*할인율*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , DIS_PER_NUM
                                  , APL_START_DT
                                  , APL_END_DT
                                  , WDAY_DIS_PER
                                  , WKD_DIS_PER
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY DIS_PER_NUM DESC) AS RK
                               FROM TB_RC_DISPERINF
                              WHERE APL_START_DT <= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                AND APL_END_DT   >= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                            ) T_DISPER
                    ON T_DISPER.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_DISPER.RK = 1
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
               ) V_PRDT
         INNER JOIN TB_CM_IMG T_IMG
		    ON T_IMG.LINK_NUM = V_PRDT.PRDT_NUM
		   AND T_IMG.IMG_SN   = 1
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON T_ANLS.LINK_NUM = V_PRDT.PRDT_NUM
         WHERE ABLE_YN='Y'
         ORDER BY CORP_LEVEL DESC, CORP_ID
       )
		 WHERE ROWNUM < TO_NUMBER(#sNum#) + 1

]]>
<!-- WHERE RK <= (CASE CAR_DIV WHEN 'CAR1'
                          THEN 2
                          WHEN 'CAR2'
                          THEN 3
                          WHEN 'CAR3'
                          THEN 3
                          WHEN 'CAR4'
                          THEN 2
                          ELSE 0
              END) -->
</select>

<!-- 관광기념품 랜덤 조회 -->
<select id="MAIN_S_21" resultMap="MAIN_R_21">
SELECT PRDT_NUM
    , CTGR
    , PRDT_NM
    , CORP_ID
    , CORP_NM
    , SIMPLE_EXP
    , SV_DIV_SN
    , SV_OPT_SN
    , NML_AMT
    , SALE_AMT
    , DIS_PER
    , SAVE_PATH
    , SAVE_FILE_NM
    , GPA_AVG
    , SUPERB_SV_YN
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
            INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
                AND PRM.PRMT_DIV = 'EVNT'
                AND PRM.STATUS_CD = 'TS03'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
        WHERE PRM_PRD.PRDT_NUM = SV2.PRDT_NUM
            AND PRM.CORP_ID = SV2.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = SV2.PRDT_NUM) AS COUPON_CNT
FROM (SELECT PRDT_NUM
            , CTGR
            , PRDT_NM
            , CORP_ID
            , CORP_NM
            , PRDT_INF AS SIMPLE_EXP
            , SV_DIV_SN
            , SV_OPT_SN
            , NML_AMT
            , SALE_AMT
            , DIS_PER
            , SAVE_PATH
            , SAVE_FILE_NM
            , (SELECT GPA_AVG FROM TB_GPA_ANLS WHERE LINK_NUM = SV.PRDT_NUM) AS GPA_AVG
            , SUPERB_SV_YN
            , (SELECT CORP_LEVEL - NVL (COMPLAIN_LEVEL, 0) + NVL (JOIN_LEVEL, 0) + NVL (AMT_LEVEL, 0)
	            FROM TB_CORP_LEVEL
	            WHERE CORP_ID = SV.CORP_ID) AS CORP_LEVEL
        FROM (SELECT SV_PRD.PRDT_NUM
                    , SV_PRD.CTGR
                    , SV_PRD.CORP_ID
                    , CORP.CORP_NM
                    , SV_PRD.PRDT_NM
                    , SV_PRD.PRDT_INF AS PRDT_INF
                    , SV_OPT.SV_DIV_SN
                    , SV_OPT.SV_OPT_SN
                    , SV_OPT.SALE_AMT
                    , SV_OPT.NML_AMT
                    , (100 - (TRUNC (SV_OPT.SALE_AMT / SV_OPT.NML_AMT, 2) * 100)) AS DIS_PER
                    , SV_OPT.SALE_NUM
                    , CM_IMG.SAVE_PATH
                    , CM_IMG.SAVE_FILE_NM
                    , SV_PRD.SUPERB_SV_YN
                    , ROW_NUMBER () OVER (PARTITION BY SV_PRD.CORP_ID ORDER BY SV_OPT.SALE_AMT, SV_OPT.SV_DIV_SN, SV_OPT.SV_OPT_SN) AS RK
                FROM TB_SV_PRDTINF SV_PRD
                	INNER JOIN TB_CORP CORP ON CORP.CORP_ID = SV_PRD.CORP_ID
                		AND CORP.TRADE_STATUS_CD = 'TS03'
                    INNER JOIN TB_SV_OPTINF SV_OPT ON SV_OPT.PRDT_NUM = SV_PRD.PRDT_NUM
	                    AND SV_OPT.SALE_AMT > 0
	                    AND SV_OPT.DDL_YN = 'N'
	                    AND SV_OPT.OPT_PRDT_NUM > SV_OPT.SALE_NUM
	                INNER JOIN TB_CM_IMG CM_IMG ON CM_IMG.LINK_NUM = SV_PRD.PRDT_NUM
                		AND CM_IMG.IMG_SN = 1
                WHERE SV_PRD.TRADE_STATUS = 'TS03'
                    AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN SV_PRD.SALE_START_DT AND SV_PRD.SALE_END_DT
                    AND SV_PRD.PRDT_NUM NOT IN (SELECT PRDT_NUM FROM TB_MAIN_CTGR_RCMD WHERE PRDT_DIV = 'SV')) SV
        WHERE RK = 1
        ORDER BY CORP_LEVEL DESC) SV2
WHERE 1 = 1
    <isNotEmpty property="sNum">
        <![CDATA[
        AND ROWNUM <= 10
        ]]>
    </isNotEmpty>
</select>

<!-- 관광기념품
	농산물 + 수산물 + 축산물 3개 가공품 3개, 향장품, 공예/공산품 2개 -->
<select id="MAIN_S_22" resultMap="MAIN_R_21">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_NM
     , SIMPLE_EXP
     , SV_DIV_SN
     , SV_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
     , SUPERB_SV_YN
  FROM (SELECT PRDT_NUM
             , CTGR
             , V_CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SV_DIV_SN
             , SV_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
             , SUPERB_SV_YN
             , ROW_NUMBER() OVER(PARTITION BY S.V_CTGR ORDER BY DBMS_RANDOM.VALUE) AS RK
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , (CASE T_PRDT.CTGR WHEN 'S200'
                                         THEN 'S100'
                                         WHEN 'S300'
                                         THEN 'S100'
                                         ELSE T_PRDT.CTGR
                         END
                       ) AS V_CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_NM
                     , NVL(T_PRDT.PRDT_INF, ' ') AS PRDT_INF
                     , T_OPT.SV_DIV_SN
                     , T_OPT.SV_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SV_DIV_SN ASC, T_OPT.SV_OPT_SN ASC ) AS RK
                     , T_PRDT.SUPERB_SV_YN
                  FROM TB_SV_PRDTINF T_PRDT
                 INNER JOIN TB_SV_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   ]]>
                   <isNotEmpty property="sCtgr">
				   AND T_PRDT.CTGR = #sCtgr#
					</isNotEmpty>
                   <isNotEmpty property="sSuperbSvYn">
				   AND T_PRDT.SUPERB_SV_YN = #sSuperbSvYn#
					</isNotEmpty>
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                   <![CDATA[
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE RK <= (CASE V_CTGR WHEN 'S100'
                        THEN 3
                        WHEN 'S400'
                        THEN 3
                        WHEN 'S500'
                        THEN 2
                        WHEN 'S600'
                        THEN 2
                        ELSE 0
              END)
]]>
</select>

<!-- 인기있수다 상품 -->
<select id="MAIN_S_23" resultMap="MAIN_R_23">
SELECT PRDT_DIV
  , PRDT_NUM
  , CORP_ID
  , PRDT_NM
  , PRDT_EXP
  , IMG_PATH
  , ETC_EXP
  , NML_AMT
  , SALE_AMT
  , PRINT_SN
FROM (SELECT PRDT_DIV
          , PRDT_NUM
          , T_MAIN_HOT.CORP_ID
          , NVL (PRDT_NM, T_C.CORP_NM) AS PRDT_NM
          , NVL (PRDT_EXP, T_C.CORP_NM) AS PRDT_EXP
          , IMG_PATH
          , ETC_EXP
          , NML_AMT
          , SALE_AMT
          , PRINT_SN
        FROM (SELECT T_HOT.PRDT_DIV
                  , T_HOT.PRDT_NUM
                  , '' AS PRDT_NM
                  , T_AD_PRDT.CORP_ID
                  , (SELECT AD_SIMPLE_EXP
                        FROM TB_AD_DFTINF
                        WHERE CORP_ID = T_AD_PRDT.CORP_ID) AS PRDT_EXP
                  , (SELECT SAVE_PATH || 'thumb/' || SAVE_FILE_NM
                        FROM TB_CM_IMG
                        WHERE LINK_NUM = T_AD_PRDT.CORP_ID
                            AND IMG_SN = 1) AS IMG_PATH
                  , '' AS ETC_EXP
                  , T_AD_AMT.NML_AMT
                  , (CASE
                        WHEN T_AD_AMT.DAYPRICE_YN = 'Y'
                        THEN T_AD_AMT.DAYPRICE_AMT
                        ELSE T_AD_AMT.SALE_AMT
                    END) AS SALE_AMT
                  , 1 AS RK
                  , T_HOT.PRINT_SN
                FROM TB_MAIN_HOT_PRDT T_HOT
                    INNER JOIN TB_AD_PRDTINF T_AD_PRDT
                    ON  T_AD_PRDT.PRDT_NUM = T_HOT.PRDT_NUM
                        AND T_AD_PRDT.TRADE_STATUS = 'TS03'
                    INNER JOIN TB_AD_AMTINF T_AD_AMT
                    ON  T_AD_AMT.PRDT_NUM = T_HOT.PRDT_NUM
                        AND T_AD_AMT.APL_DT = TO_CHAR (SYSDATE, 'YYYYMMDD')
                WHERE T_HOT.PRINT_DIV = 'HOT'
                    AND T_HOT.PRDT_DIV = 'AD'
                    AND T_AD_AMT.SALE_AMT IS NOT NULL AND T_AD_AMT.SALE_AMT != 0
                    AND T_AD_AMT.NML_AMT IS NOT NULL AND T_AD_AMT.NML_AMT != 0

    UNION ALL

                SELECT T_HOT.PRDT_DIV
                  , T_HOT.PRDT_NUM
                  , T_RC_PRDT.PRDT_NM
                  , T_RC_PRDT.CORP_ID
                  , '' AS PRDT_EXP
                  , (SELECT CAR_IMG
                        FROM TB_RC_CARDIV
                        WHERE RC_CARDIV_NUM = T_RC_PRDT.RC_CARDIV_NUM) AS IMG_PATH
                  , '' AS ETC_EXP
                  , (CASE WHEN T_RC_PRDT.APPROX_NML_AMT IS NOT NULL THEN T_RC_PRDT.APPROX_NML_AMT ELSE T_RC_AMT.TM24_AMT END) AS NML_AMT
                  , (CASE WHEN T_RC_PRDT.APPROX_SALE_AMT IS NOT NULL THEN T_RC_PRDT.APPROX_SALE_AMT
                    ELSE TRUNC ((T_RC_AMT.TM24_AMT * (100 - (CASE
                      WHEN INSTR (T_RC_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR (SYSDATE, 'D') - 1) > 0
                      THEN T_RC_DISPER.WKD_DIS_PER
                      ELSE T_RC_DISPER.WDAY_DIS_PER
                    END)) / 100), - 2)
                    END) AS SALE_AMT
                  , ROW_NUMBER() OVER (PARTITION BY T_HOT.PRDT_NUM ORDER BY T_RC_DISPER.DIS_PER_NUM DESC) AS RK
                  , T_HOT.PRINT_SN
                FROM TB_MAIN_HOT_PRDT T_HOT
                    INNER JOIN TB_RC_PRDTINF T_RC_PRDT
                    ON  T_RC_PRDT.PRDT_NUM = T_HOT.PRDT_NUM
                        AND T_RC_PRDT.TRADE_STATUS = 'TS03'
                    INNER JOIN TB_RC_DFTINF T_RC_DFT
                    ON  T_RC_DFT.CORP_ID = T_RC_PRDT.CORP_ID
                    INNER JOIN TB_RC_AMTINF T_RC_AMT
                    ON  T_RC_AMT.PRDT_NUM = T_HOT.PRDT_NUM
                    INNER JOIN TB_RC_DISPERINF T_RC_DISPER
                    ON  T_RC_DISPER.PRDT_NUM = T_HOT.PRDT_NUM
                        AND TO_CHAR (SYSDATE + 1, 'YYYYMMDD') BETWEEN APL_START_DT AND APL_END_DT
                WHERE T_HOT.PRINT_DIV = 'HOT'
                    AND T_HOT.PRDT_DIV = 'RC'

                UNION ALL

                SELECT T_HOT.PRDT_DIV
                  , T_HOT.PRDT_NUM
                  , T_SP_PRDT.PRDT_NM
                  , T_SP_PRDT.CORP_ID
                  , T_SP_PRDT.PRDT_INF AS PRDT_EXP
                  , CASE WHEN T_SP_PRDT.API_IMG_THUMB IS NOT NULL THEN API_IMG_THUMB ELSE
	                        (
	                          (SELECT SAVE_PATH
	                                          || 'thumb/'
	                                          || SAVE_FILE_NM
	                          FROM    TB_CM_IMG
	                          WHERE   LINK_NUM = T_HOT.PRDT_NUM
	                          AND     IMG_SN   = 1
	                          )
	                        ) END
                             AS IMG_PATH
                  , '' AS ETC_EXP
                  , T_SP_OPT.NML_AMT
                  , T_SP_OPT.SALE_AMT
                  , ROW_NUMBER() OVER (PARTITION BY T_HOT.PRDT_NUM ORDER BY SALE_AMT) AS RK
                  , T_HOT.PRINT_SN
                FROM TB_MAIN_HOT_PRDT T_HOT
                    INNER JOIN TB_SP_PRDTINF T_SP_PRDT
                    ON  T_SP_PRDT.PRDT_NUM = T_HOT.PRDT_NUM
                        AND TRADE_STATUS = 'TS03'
                        AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN T_SP_PRDT.SALE_START_DT AND T_SP_PRDT.SALE_END_DT
                    INNER JOIN TB_SP_OPTINF T_SP_OPT
                    ON  T_SP_OPT.PRDT_NUM = T_HOT.PRDT_NUM AND T_SP_OPT.PRINT_YN = 'Y'
                WHERE T_HOT.PRINT_DIV = 'HOT'
                    AND T_HOT.PRDT_DIV LIKE 'C%'

                UNION ALL

                SELECT T_HOT.PRDT_DIV
                  , T_HOT.PRDT_NUM
                  , T_SV_PRDT.PRDT_NM
                  , T_SV_PRDT.CORP_ID
                  , T_SV_PRDT.PRDT_INF AS PRDT_EXP
                  , (SELECT SAVE_PATH || 'thumb/' || SAVE_FILE_NM
                        FROM TB_CM_IMG
                        WHERE LINK_NUM = T_HOT.PRDT_NUM
                            AND IMG_SN = 1) AS IMG_PATH
                  , '' AS ETC_EXP
                  , T_SV_OPT.NML_AMT
                  , T_SV_OPT.SALE_AMT
                  , ROW_NUMBER() OVER (PARTITION BY T_HOT.PRDT_NUM ORDER BY SALE_AMT) AS RK
                  , T_HOT.PRINT_SN
                FROM TB_MAIN_HOT_PRDT T_HOT
                    INNER JOIN TB_SV_PRDTINF T_SV_PRDT
                    ON  T_SV_PRDT.PRDT_NUM = T_HOT.PRDT_NUM
                        AND TRADE_STATUS = 'TS03'
                        AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN T_SV_PRDT.SALE_START_DT AND T_SV_PRDT.SALE_END_DT
                    INNER JOIN TB_SV_OPTINF T_SV_OPT
                    ON  T_SV_OPT.PRDT_NUM = T_HOT.PRDT_NUM
                WHERE T_HOT.PRINT_DIV = 'HOT'
                    AND T_HOT.PRDT_DIV = 'SV') T_MAIN_HOT
            INNER JOIN TB_CORP T_C
            ON  T_C.CORP_ID = T_MAIN_HOT.CORP_ID
                AND T_C.TRADE_STATUS_CD = 'TS03'
        WHERE RK = 1)
ORDER BY
    PRINT_SN
</select>

<!-- 카테고리별 판매순 상품 (최근 7일 동안 예약건 중) -->
<select id="MAIN_S_24" resultMap="MAIN_R_23">
<![CDATA[
SELECT PRDT_DIV
        , T_HOT.PRDT_NUM
        , CORP_ID
        , PRDT_NM
        , PRDT_EXP
        , IMG_PATH
        , ETC_EXP
        , NML_AMT
        , SALE_AMT
    FROM (
      SELECT PRDT_DIV, PRDT_NUM
          FROM (
              SELECT 'AD' AS PRDT_DIV
              	, T_PRDT.PRDT_NUM
              	, ROW_NUMBER() OVER(ORDER BY COUNT(T_PRDT.PRDT_NUM) DESC) AS RK
		      FROM TB_RSV T_RSV
		        INNER JOIN (
		            SELECT RSV_NUM, T_RSV.PRDT_NUM
		              FROM TB_AD_RSV T_RSV
		                INNER JOIN TB_AD_PRDTINF T_PRDT ON T_PRDT.PRDT_NUM=T_RSV.PRDT_NUM
		                  AND TRADE_STATUS='TS03'
		        ) T_PRDT ON T_PRDT.RSV_NUM=T_RSV.RSV_NUM
		      WHERE
		      T_RSV.RSV_STATUS_CD = 'RS02'
		      AND T_RSV.REG_DTTM >= TO_DATE(SYSDATE-7, 'YYYY/MM/DD')
		      GROUP BY T_PRDT.PRDT_NUM
		    UNION ALL
		      SELECT 'RC' AS PRDT_DIV
		      	, T_PRDT.PRDT_NUM
		      	, ROW_NUMBER() OVER(ORDER BY COUNT(T_PRDT.PRDT_NUM) DESC) AS RK
		      FROM TB_RSV T_RSV
		        INNER JOIN (
		            SELECT RSV_NUM, T_RSV.PRDT_NUM
		              FROM TB_RC_RSV T_RSV
		                INNER JOIN TB_RC_PRDTINF T_PRDT ON T_PRDT.PRDT_NUM=T_RSV.PRDT_NUM
		                  AND TRADE_STATUS='TS03'
		        ) T_PRDT ON T_PRDT.RSV_NUM=T_RSV.RSV_NUM
		      WHERE
		      T_RSV.RSV_STATUS_CD = 'RS02'
		      AND T_RSV.REG_DTTM >= TO_DATE(SYSDATE-7, 'YYYY/MM/DD')
		      GROUP BY T_PRDT.PRDT_NUM
		    UNION ALL
		      SELECT PRDT_DIV, T_PRDT.PRDT_NUM, ROW_NUMBER() OVER(PARTITION BY PRDT_DIV ORDER BY COUNT(T_PRDT.PRDT_NUM) DESC) AS RK
		      FROM TB_RSV T_RSV
		        INNER JOIN (
		            SELECT RSV_NUM, CONCAT(SUBSTR(T_PRDT.CTGR, 0,2),'00') AS PRDT_DIV, T_PRDT.PRDT_NUM
		              FROM TB_SP_RSV T_RSV
		                INNER JOIN TB_SP_PRDTINF T_PRDT ON T_PRDT.PRDT_NUM=T_RSV.PRDT_NUM
		                  AND TRADE_STATUS='TS03'
		        ) T_PRDT ON T_PRDT.RSV_NUM=T_RSV.RSV_NUM
		      WHERE
		      T_RSV.RSV_STATUS_CD = 'RS02'
		      AND T_RSV.REG_DTTM >= TO_DATE(SYSDATE-7, 'YYYY/MM/DD')
		        AND PRDT_DIV!='C400'
		      GROUP BY PRDT_DIV, T_PRDT.PRDT_NUM
		    UNION ALL
		      SELECT 'SV' AS PRDT_DIV, T_PRDT.PRDT_NUM, ROW_NUMBER() OVER(ORDER BY COUNT(T_PRDT.PRDT_NUM) DESC) AS RK
		      FROM TB_RSV T_RSV
		        INNER JOIN (
		            SELECT RSV_NUM, T_RSV.PRDT_NUM
		              FROM TB_SV_RSV T_RSV
		                INNER JOIN TB_SV_PRDTINF T_PRDT ON T_PRDT.PRDT_NUM=T_RSV.PRDT_NUM
		                  AND TRADE_STATUS='TS03'
		        ) T_PRDT ON T_PRDT.RSV_NUM=T_RSV.RSV_NUM
		      WHERE
		      T_RSV.RSV_STATUS_CD = 'RS02'
		      AND T_RSV.REG_DTTM >= TO_DATE(SYSDATE-7, 'YYYY/MM/DD')
		      GROUP BY T_PRDT.PRDT_NUM
          )
          WHERE RK=1
    ) T_HOT
    INNER JOIN (
        SELECT T_PRD.PRDT_NUM
        	, T_CORP.CORP_ID
            , CORP_NM AS PRDT_NM
            , PRDT_EXP
            , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
            , (SELECT CD_NM FROM TB_CD WHERE CD_NUM=T_DFT.AD_AREA) AS ETC_EXP
            , NVL(T_AMT.NML_AMT, 0) AS NML_AMT
            , NVL((CASE WHEN (APL_DT=TO_CHAR(SYSDATE,'YYYYMMDD') AND DAYPRICE_YN ='Y') THEN DAYPRICE_AMT ELSE SALE_AMT END), 0) AS SALE_AMT
              FROM TB_AD_PRDTINF T_PRD
                INNER JOIN TB_CORP T_CORP ON T_CORP.CORP_ID=T_PRD.CORP_ID
                INNER JOIN TB_AD_DFTINF T_DFT ON T_DFT.CORP_ID=T_PRD.CORP_ID
                INNER JOIN TB_AD_AMTINF T_AMT ON T_AMT.PRDT_NUM = T_PRD.PRDT_NUM
                   AND T_AMT.APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_CORP.CORP_ID
                   AND T_IMG.IMG_SN   = 1
       UNION ALL
         SELECT T_PRD.PRDT_NUM
         	, '' AS CORP_ID
            , T_DIV.PRDT_NM
            , (SELECT CORP_NM FROM TB_CORP WHERE CORP_ID=T_PRD.CORP_ID) AS PRDT_EXP
            , CAR_IMG AS IMG_PATH
            , (SELECT CD_NM FROM TB_CD WHERE CD_NUM=T_PRD.ISR_DIV) AS ETC_EXP
            , T_AMT.NML_AMT AS NML_AMT
            , T_AMT.SALE_AMT AS SALE_AMT
              FROM TB_RC_PRDTINF T_PRD
              	INNER JOIN TB_RC_CARDIV T_DIV
              	  ON T_DIV.RC_CARDIV_NUM=T_PRD.RC_CARDIV_NUM
              		AND USE_YN='Y'
                INNER JOIN (
                    SELECT V_PRDT.PRDT_NUM
                             , V_PRDT.TM24_AMT AS NML_AMT
                             , TRUNC((V_PRDT.TM24_AMT * (100 - V_PRDT.DIS_PER) / 100), -2) AS SALE_AMT
                          FROM (SELECT T_PRDT.PRDT_NUM
                                     , T_AMT.TM24_AMT
                                     , (CASE WHEN TO_NUMBER(T_DFT.DIS_PER_APL_TM) > 24
                                             THEN 0
                                             /*주말할인율 적용여부*/
                                             ELSE (CASE T_DFT.WKD_DIS_PER_APL_YN
                                                   WHEN 'Y'
                                                   /*입력된 예약 시작일에 대한 요일 체크*/
                                                   THEN (CASE WHEN INSTR(T_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR(SYSDATE, 'D') - 1) > 0
                                                              THEN T_DISPER.WKD_DIS_PER
                                                              ELSE T_DISPER.WDAY_DIS_PER
                                                          END
                                                        )
                                                   ELSE T_DISPER.WDAY_DIS_PER
                                                    END
                                                  )
                                          END) AS DIS_PER
                                  FROM TB_RC_PRDTINF T_PRDT
                                 INNER JOIN TB_RC_DFTINF T_DFT
                                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                                  /*요금*/
                                 INNER JOIN (SELECT PRDT_NUM
                                                  , TM24_AMT
                                                  , RANK() OVER(PARTITION BY PRDT_NUM ORDER BY (TO_CHAR(SYSDATE+1, 'YYYYMMDD') - APL_DT)) AS RK
                                               FROM TB_RC_AMTINF
                                            ) T_AMT
                                    ON T_AMT.RK = 1
                                   AND T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                                   /*할인율*/
                                 INNER JOIN (SELECT PRDT_NUM
                                                  , WDAY_DIS_PER
                                                  , WKD_DIS_PER
                                                  , RANK() OVER(PARTITION BY PRDT_NUM ORDER BY DIS_PER_NUM DESC) AS RK
                                               FROM TB_RC_DISPERINF
                                              WHERE APL_START_DT <= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                                AND APL_END_DT   >= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                            ) T_DISPER
                                    ON T_DISPER.PRDT_NUM = T_PRDT.PRDT_NUM
                                   AND T_DISPER.RK = 1
                                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
                               ) V_PRDT
                ) T_AMT ON T_AMT.PRDT_NUM = T_PRD.PRDT_NUM
       UNION ALL
         SELECT T_PRD.PRDT_NUM
         	, '' AS CORP_ID
            , PRDT_NM
            , PRDT_INF AS PRDT_EXP
            , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
            , '' AS ETC_EXP
            , NVL(T_OPT.NML_AMT, 0) AS NML_AMT
            , NVL(T_OPT.SALE_AMT, 0) AS SALE_AMT
              FROM TB_SP_PRDTINF T_PRD
                LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_PRD.PRDT_NUM
                   AND T_IMG.IMG_SN   = 1
                LEFT OUTER JOIN TB_SP_OPTINF T_OPT ON T_OPT.PRDT_NUM = T_PRD.PRDT_NUM
				   AND T_OPT.SP_DIV_SN = 1
				   AND T_OPT.SP_OPT_SN = 1
       UNION ALL
         SELECT T_PRD.PRDT_NUM
         	, '' AS CORP_ID
            , PRDT_NM
            , PRDT_INF AS PRDT_EXP
            , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
            , '' AS ETC_EXP
            , NVL(T_OPT.NML_AMT, 0) AS NML_AMT
            , NVL(T_OPT.SALE_AMT, 0) AS SALE_AMT
              FROM TB_SV_PRDTINF T_PRD
	            INNER JOIN TB_SV_OPTINF T_OPT ON T_OPT.PRDT_NUM = T_PRD.PRDT_NUM
	               AND T_OPT.VIEW_SN = 1
                   AND T_OPT.VIEW_SN = 1
                LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_PRD.PRDT_NUM
                   AND T_IMG.IMG_SN   = 1

    ) T_PRDT ON T_PRDT.PRDT_NUM=T_HOT.PRDT_NUM
    WHERE PRDT_DIV NOT IN (SELECT PRDT_DIV FROM TB_MAIN_HOT_PRDT WHERE PRINT_DIV='HOT')
    ORDER BY DBMS_RANDOM.VALUE
]]>
</select>

<!-- '즐거움' 폭발 상품 -->
<select id="MAIN_S_25" resultMap="MAIN_R_25">
<![CDATA[
SELECT PRDT_NUM
    , PRDT_DIV
    , PRDT_EXP
    , IMG_PATH
  FROM (
     SELECT T_HOT.PRDT_NUM
         , PRDT_DIV
         , PRDT_EXP
         , IMG_PATH
       FROM TB_MAIN_HOT_PRDT T_HOT
       INNER JOIN (
           SELECT T_PRMT.PRMT_NUM AS PRD_NUM
                 , PRMT_NM AS PRDT_EXP
                 , PRDT_NUM
             FROM TB_PRMT T_PRMT
             INNER JOIN TB_PRMT_PRDT T_PRPD ON T_PRPD.PRMT_NUM=T_PRMT.PRMT_NUM
                 AND PRINT_SN = 1
             WHERE END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
         UNION ALL
           SELECT T_KWA.KWA_NUM AS PRD_NUM
                 , KWA_NM AS PRDT_EXP
                 , PRDT_NUM
             FROM TB_KWA T_KWA
             INNER JOIN (
                SELECT KWA_NUM
                  , PRDT_NUM
                  , ROW_NUMBER() OVER (PARTITION BY KWA_NUM ORDER BY CORP_CD, PRINT_SN ) AS K_RK
                 FROM TB_KWA_PRDT) T_KWPD
              ON T_KWPD.KWA_NUM=T_KWA.KWA_NUM
                 AND T_KWPD.K_RK = 1
             WHERE END_DTTM >= TO_CHAR(SYSDATE, 'YYYYMMDD')
         UNION ALL
           SELECT T_ADM.RCMD_NUM AS PRD_NUM
                 , SUBJECT AS PRDT_EXP
                 , PRDT_NUM
             FROM TB_ADM_RCMD T_ADM
             INNER JOIN (
                 SELECT CORP_ID, PRDT_NUM
                   FROM (
                         SELECT CORP_ID, PRDT_NUM, ROW_NUMBER() OVER (PARTITION BY CORP_ID ORDER BY VIEW_SN ASC ) as RK
                           FROM TB_AD_PRDTINF
                       UNION ALL
                         SELECT CORP_ID, PRDT_NUM, ROW_NUMBER() OVER (PARTITION BY CORP_ID ORDER BY PRDT_NUM ASC ) as RK
                           FROM TB_RC_PRDTINF
                       UNION ALL
                         SELECT CORP_ID, PRDT_NUM, ROW_NUMBER() OVER (PARTITION BY CORP_ID ORDER BY PRDT_NUM ASC ) as RK
                           FROM TB_SP_PRDTINF
                       UNION ALL
                         SELECT CORP_ID, PRDT_NUM, ROW_NUMBER() OVER (PARTITION BY CORP_ID ORDER BY PRDT_NUM ASC ) as RK
                           FROM TB_SV_PRDTINF
                   )
                   WHERE RK=1
             ) T_PRDT2 ON T_PRDT2.CORP_ID=T_ADM.CORP_ID
       ) T_PRDT3 ON T_PRDT3.PRD_NUM=T_HOT.PRDT_NUM
       INNER JOIN (
           SELECT PRDT_NUM
               , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
             FROM TB_AD_PRDTINF T_PRDT
               INNER JOIN TB_CORP T_CORP ON T_CORP.CORP_ID=T_PRDT.CORP_ID
               LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_CORP.CORP_ID
                   AND T_IMG.IMG_SN = 1
          UNION ALL
            SELECT PRDT_NUM
               , CAR_IMG AS IMG_PATH
             FROM TB_RC_PRDTINF T_PRDT
               INNER JOIN TB_RC_CARDIV T_DIV ON T_DIV.RC_CARDIV_NUM=T_PRDT.RC_CARDIV_NUM
          UNION ALL
            SELECT PRDT_NUM
               , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
             FROM TB_SP_PRDTINF T_PRDT
               LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_PRDT.PRDT_NUM
                   AND T_IMG.IMG_SN = 1
             WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN SALE_START_DT AND SALE_END_DT
               AND T_PRDT.TRADE_STATUS = 'TS03'
          UNION ALL
            SELECT PRDT_NUM
               , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
             FROM TB_SV_PRDTINF T_PRDT
               LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_PRDT.PRDT_NUM
                   AND T_IMG.IMG_SN = 1
             WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN SALE_START_DT AND SALE_END_DT
               AND T_PRDT.TRADE_STATUS = 'TS03'
       ) T_PRDT1 ON T_PRDT1.PRDT_NUM=T_PRDT3.PRDT_NUM
         WHERE PRINT_DIV='URL'
         ORDER BY PRINT_SN
   )
 WHERE ROWNUM < 5
]]>
</select>

<!-- 지역별 핫 플레이스 상품 -->
<select id="MAIN_S_26" resultMap="MAIN_R_26">
SELECT PRDT_NUM
        , AREA_DIV
        , PRDT_DIV
        , PRDT_GUBUN
        , PRDT_NM
        , CTGR
        , CTGR_NM
        , IMG_PATH
  FROM (
    SELECT T_AREA.PRDT_NUM
            , AREA_DIV
            , PRDT_DIV
            , PRDT_GUBUN
            , PRDT_NM
            , CTGR
            , CTGR_NM
            , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
            , ROW_NUMBER() OVER (PARTITION BY AREA_DIV, CTGR ORDER BY DBMS_RANDOM.VALUE ) AS RK
        FROM TB_MAIN_AREA_PRDT T_AREA
        INNER JOIN (
          SELECT PRDT_NUM
          	  , '' AS PRDT_GUBUN
              , AD_NM AS PRDT_NM
              , 'AD' AS CTGR
              , '숙소' AS CTGR_NM
              , SAVE_PATH
              , SAVE_FILE_NM
            FROM TB_AD_PRDTINF T_PRDT
              INNER JOIN TB_AD_DFTINF T_DFT ON T_DFT.CORP_ID=T_PRDT.CORP_ID
              LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_DFT.CORP_ID
                  AND T_IMG.IMG_SN = 1
            WHERE T_PRDT.TRADE_STATUS = 'TS03'
         UNION ALL
           SELECT PRDT_NUM
           	  , PRDT_DIV AS PRDT_GUBUN
              , PRDT_NM
              , CONCAT(SUBSTR(T_PRDT.CTGR, 0,2),'00') AS CTGR
              , (SELECT CD_NM FROM TB_CD WHERE CD_NUM=CONCAT(SUBSTR(T_PRDT.CTGR, 0,2),'00')) AS CTGR_NM
              , SAVE_PATH
              , SAVE_FILE_NM
            FROM TB_SP_PRDTINF T_PRDT
              LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_PRDT.PRDT_NUM
                  AND T_IMG.IMG_SN = 1
            WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN SALE_START_DT AND SALE_END_DT
              AND T_PRDT.TRADE_STATUS = 'TS03'
      ) T_PRDT ON T_PRDT.PRDT_NUM=T_AREA.PRDT_NUM
   )
   WHERE RK = 1
</select>

<!-- 설정 카테고리별 추천 상품 -->
<select id="MAIN_S_27" resultMap="MAIN_R_27">
<![CDATA[
SELECT PRDT_DIV
        , T_RCMD.PRDT_NUM
        , CORP_ID
        , PRDT_NM
        , PRDT_EXP
        , IMG_PATH
        , ETC_EXP
        , NML_AMT
        , SALE_AMT
        , '' AS EVENT_CNT
        , '' AS COUPON_CNT
        , '' AS DAYPRICE_YN
        , CASE WHEN TAMNACARD_MNG_YN = 'C' OR (TAMNACARD_MNG_YN = 'P' AND TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
    FROM TB_MAIN_CTGR_RCMD T_RCMD
    INNER JOIN (
        SELECT T_PRD.PRDT_NUM
            , AD_NM AS PRDT_NM
            , T_CORP.CORP_ID
            , AD_SIMPLE_EXP AS PRDT_EXP
            , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
            , (SELECT CD_NM FROM TB_CD WHERE CD_NUM=T_DFT.AD_AREA) AS ETC_EXP
            , NVL(T_AMT.NML_AMT, 0) AS NML_AMT
            , NVL((CASE WHEN (APL_DT=TO_CHAR(SYSDATE,'YYYYMMDD') AND DAYPRICE_YN ='Y') THEN DAYPRICE_AMT ELSE SALE_AMT END), 0) AS SALE_AMT
            , ROW_NUMBER() OVER(PARTITION BY T_PRD.PRDT_NUM ORDER BY (CASE WHEN (APL_DT=TO_CHAR(SYSDATE,'YYYYMMDD') AND DAYPRICE_YN ='Y') THEN DAYPRICE_AMT ELSE SALE_AMT END)) AS RK
            , TAMNACARD_MNG_YN
            , TAMNACARD_PRDT_YN
              FROM TB_AD_PRDTINF T_PRD
                INNER JOIN TB_MAIN_CTGR_RCMD AS A ON T_PRD.PRDT_NUM = A.PRDT_NUM AND PRDT_DIV = 'AD'
                INNER JOIN TB_CORP T_CORP ON T_CORP.CORP_ID=T_PRD.CORP_ID
                INNER JOIN TB_AD_DFTINF T_DFT ON T_DFT.CORP_ID=T_PRD.CORP_ID
                INNER JOIN TB_AD_AMTINF T_AMT ON T_AMT.PRDT_NUM = T_PRD.PRDT_NUM
                   AND T_AMT.APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_CORP.CORP_ID
                   AND T_IMG.IMG_SN   = 1
       UNION ALL
         SELECT T_PRD.PRDT_NUM
            , T_DIV.PRDT_NM  || ' / ' || (SELECT CD_NM
		          FROM TB_CD
		         WHERE CD_NUM = T_DIV.USE_FUEL_DIV
		       ) AS PRDT_NM
            , '' AS CORP_ID
            , CORP_NM AS PRDT_EXP
            , CAR_IMG AS IMG_PATH
            , (SELECT CD_NM FROM TB_CD WHERE CD_NUM=T_PRD.ISR_DIV) AS ETC_EXP
            , T_AMT.NML_AMT AS NML_AMT
            , T_AMT.SALE_AMT AS SALE_AMT
            , ROW_NUMBER() OVER(PARTITION BY T_PRD.PRDT_NUM ORDER BY T_AMT.SALE_AMT) AS RK
            , TAMNACARD_MNG_YN
            , TAMNACARD_PRDT_YN
              FROM TB_RC_PRDTINF T_PRD
                INNER JOIN TB_RC_CARDIV T_DIV
              	  ON T_DIV.RC_CARDIV_NUM=T_PRD.RC_CARDIV_NUM
              		AND USE_YN='Y'
                INNER JOIN (
                    SELECT V_PRDT.PRDT_NUM
                             , V_PRDT.TM24_AMT AS NML_AMT
                             , TRUNC((V_PRDT.TM24_AMT * (100 - V_PRDT.DIS_PER) / 100), -2) AS SALE_AMT
                          FROM (SELECT T_PRDT.PRDT_NUM
                                     , T_AMT.TM24_AMT
                                     , (CASE WHEN TO_NUMBER(T_DFT.DIS_PER_APL_TM) > 24
                                             THEN 0
                                             /*주말할인율 적용여부*/
                                             ELSE (CASE T_DFT.WKD_DIS_PER_APL_YN
                                                   WHEN 'Y'
                                                   /*입력된 예약 시작일에 대한 요일 체크*/
                                                   THEN (CASE WHEN INSTR(T_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR(SYSDATE, 'D') - 1) > 0
                                                              THEN T_DISPER.WKD_DIS_PER
                                                              ELSE T_DISPER.WDAY_DIS_PER
                                                          END
                                                        )
                                                   ELSE T_DISPER.WDAY_DIS_PER
                                                    END
                                                  )
                                          END) AS DIS_PER
                                  FROM TB_RC_PRDTINF T_PRDT
                                 INNER JOIN TB_RC_DFTINF T_DFT
                                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                                  /*요금*/
                                 INNER JOIN (SELECT PRDT_NUM
                                                  , TM24_AMT
                                                  , RANK() OVER(PARTITION BY PRDT_NUM ORDER BY (TO_CHAR(SYSDATE+1, 'YYYYMMDD') - APL_DT)) AS RK
                                               FROM TB_RC_AMTINF
                                            ) T_AMT
                                    ON T_AMT.RK = 1
                                   AND T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                                   /*할인율*/
                                 INNER JOIN (SELECT PRDT_NUM
                                                  , WDAY_DIS_PER
                                                  , WKD_DIS_PER
                                                  , RANK() OVER(PARTITION BY PRDT_NUM ORDER BY DIS_PER_NUM DESC) AS RK
                                               FROM TB_RC_DISPERINF
                                              WHERE APL_START_DT <= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                                AND APL_END_DT   >= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                            ) T_DISPER
                                    ON T_DISPER.PRDT_NUM = T_PRDT.PRDT_NUM
                                   AND T_DISPER.RK = 1
                                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
                               ) V_PRDT
                ) T_AMT ON T_AMT.PRDT_NUM = T_PRD.PRDT_NUM
                INNER JOIN TB_MAIN_CTGR_RCMD AS A ON T_PRD.PRDT_NUM = A.PRDT_NUM AND A.PRDT_DIV = 'RC'
                LEFT JOIN TB_CORP T_CORP ON T_CORP.CORP_ID = T_PRD.CORP_ID
       UNION ALL
        SELECT
            A.PRDT_NUM,
            B.PRDT_NM,
            '' AS CORP_ID,
            B.PRDT_INF AS PRDT_EXP,
            SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH,
            B.PRDT_DIV AS ETC_EXP,
            C.NML_AMT,
            C.SALE_AMT,
            1 AS RK,
            TAMNACARD_MNG_YN,
            TAMNACARD_PRDT_YN
        FROM TB_MAIN_CTGR_RCMD AS A
        JOIN TB_SP_PRDTINF AS B
        ON A.PRDT_NUM = B.PRDT_NUM
        JOIN(
            SELECT
                PRDT_NUM,MIN(NML_AMT) AS NML_AMT, MIN(SALE_AMT) AS SALE_AMT
            FROM TB_SP_OPTINF
            WHERE 1=1
            AND DDL_YN = 'N'
            GROUP BY PRDT_NUM
        ) AS C
        ON A.PRDT_NUM = C.PRDT_NUM
        JOIN TB_CM_IMG AS D
        ON A.PRDT_NUM = D.LINK_NUM AND IMG_SN = 1
        LEFT JOIN TB_CORP T_CORP ON T_CORP.CORP_ID = B.CORP_ID
        WHERE 1=1
        AND A.PRDT_DIV IN ('C100','C200','C300')
        AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN SALE_START_DT AND SALE_END_DT
        AND TRADE_STATUS = 'TS03'
       UNION ALL
         SELECT T_PRD.PRDT_NUM
         	, PRDT_NM
         	, '' AS CORP_ID
            , PRDT_INF AS PRDT_EXP
            , SAVE_PATH || 'thumb/' || SAVE_FILE_NM AS IMG_PATH
            , '' AS ETC_EXP
            , NVL(T_OPT.NML_AMT, 0) AS NML_AMT
            , NVL(T_OPT.SALE_AMT, 0) AS SALE_AMT
            , ROW_NUMBER() OVER(PARTITION BY T_PRD.PRDT_NUM ORDER BY T_OPT.SALE_AMT) AS RK
            , TAMNACARD_MNG_YN
            , TAMNACARD_PRDT_YN
              FROM TB_SV_PRDTINF T_PRD
                INNER JOIN TB_MAIN_CTGR_RCMD AS A ON T_PRD.PRDT_NUM = A.PRDT_NUM AND A.PRDT_DIV = 'SV'
	            INNER JOIN TB_SV_OPTINF T_OPT ON T_OPT.PRDT_NUM = T_PRD.PRDT_NUM
	               AND T_OPT.VIEW_SN = 1
                   AND T_OPT.VIEW_SN = 1
                LEFT OUTER JOIN TB_CM_IMG T_IMG ON T_IMG.LINK_NUM = T_PRD.PRDT_NUM
                   AND T_IMG.IMG_SN   = 1
                LEFT JOIN TB_CORP T_CORP ON T_CORP.CORP_ID = T_PRD.CORP_ID
             WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN SALE_START_DT AND SALE_END_DT
                   AND T_OPT.VIEW_SN = 1
    ) T_PRDT ON T_PRDT.PRDT_NUM=T_RCMD.PRDT_NUM
        WHERE RK=1
          AND SALE_AMT!=0
        ORDER BY PRINT_SN
]]>
</select>

<!-- 방문예정 메일 발송 추천 상품 -->
<select id="MAIN_S_28" resultMap="MAIN_R_28">
SELECT PRDT_DIV
    , PRDT_NUM
    , PRDT_NM
    , CORP_ID
    , PRDT_EXP
    , IMG_PATH
    , ETC_EXP
    , NML_AMT
    , SALE_AMT
FROM (SELECT MCR.PRDT_DIV
        , MCR.PRDT_NUM
        , SP_PRD.PRDT_NM
        , SP_PRD.CORP_ID
        , SP_PRD.PRDT_INF AS PRDT_EXP
        , (CM_IMG.SAVE_PATH || 'thumb/' || CM_IMG.SAVE_FILE_NM) AS IMG_PATH
        , CORP.CORP_NM AS ETC_EXP
        , SP_OPT.NML_AMT
        , SP_OPT.SALE_AMT
        , ROW_NUMBER() OVER (PARTITION BY MCR.PRDT_NUM ORDER BY SP_OPT.SALE_AMT) AS RK
    FROM TB_MAIN_CTGR_RCMD MCR
        INNER JOIN TB_SP_PRDTINF SP_PRD ON SP_PRD.PRDT_NUM = MCR.PRDT_NUM
            AND TRADE_STATUS = 'TS03'
            AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN SP_PRD.SALE_START_DT AND SP_PRD.SALE_END_DT
        INNER JOIN TB_CORP CORP         ON CORP.CORP_ID = SP_PRD.CORP_ID
            AND CORP.TRADE_STATUS_CD = 'TS03'
        INNER JOIN TB_SP_OPTINF SP_OPT  ON SP_OPT.PRDT_NUM = SP_PRD.PRDT_NUM
            AND SP_OPT.PRINT_YN = 'Y'
            AND SP_OPT.SALE_AMT > 0
            AND SP_OPT.DDL_YN = 'N'
            AND SP_OPT.OPT_PRDT_NUM > SALE_NUM
            AND (SP_OPT.APL_DT IS NULL OR SP_OPT.APL_DT >= TO_CHAR (SYSDATE, 'YYYYMMDD'))
        INNER JOIN TB_CM_IMG CM_IMG     ON CM_IMG.LINK_NUM = SP_PRD.PRDT_NUM
            AND CM_IMG.IMG_SN = 1
    WHERE MCR.PRDT_DIV IN ('C200', 'C300')
    ORDER BY MCR.PRDT_DIV, MCR.PRINT_SN) SP
WHERE RK = 1
</select>

<!-- 메인 카테고리 추천 상품_숙박 -->
<select id="MAIN_S_29" resultMap="MAIN_R_27">
SELECT PRDT_DIV
    , PRDT_NUM
    , PRDT_NM
    , CORP_ID
    , PRDT_EXP
    , IMG_PATH
    , ETC_EXP
    , NML_AMT
    , SALE_AMT
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
        	INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
        		AND PRM.PRMT_DIV = 'EVNT'
            	AND PRM.STATUS_CD = 'TS03'
            	AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
        WHERE PRM_PRD.PRDT_NUM = AD.PRDT_NUM
            AND PRM.CORP_ID = AD.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = AD.PRDT_NUM) AS COUPON_CNT
    , DAYPRICE_YN
    , TAMNACARD_YN
FROM (SELECT MCR.PRDT_DIV
            , MCR.PRDT_NUM
            , AD_DFT.AD_NM AS PRDT_NM
            , AD_PRD.CORP_ID
            , AD_DFT.AD_SIMPLE_EXP AS PRDT_EXP
            , (CM_IMG.SAVE_PATH || 'thumb/' || CM_IMG.SAVE_FILE_NM) AS IMG_PATH
            , (SELECT CD_NM FROM TB_CD WHERE CD_NUM = AD_DFT.AD_AREA) AS ETC_EXP
            , AD_AMT.NML_AMT
            , DECODE (AD_AMT.DAYPRICE_YN, 'Y', AD_AMT.DAYPRICE_AMT, AD_AMT.SALE_AMT) AS SALE_AMT
            , AD_AMT.DAYPRICE_YN
            , ROW_NUMBER() OVER (PARTITION BY MCR.PRDT_NUM ORDER BY (DECODE (AD_AMT.DAYPRICE_YN, 'Y', AD_AMT.DAYPRICE_AMT, AD_AMT.SALE_AMT))) AS RK
            , CASE WHEN CORP.TAMNACARD_MNG_YN = 'C' OR (CORP.TAMNACARD_MNG_YN = 'P' AND AD_PRD.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
        FROM TB_MAIN_CTGR_RCMD MCR
            INNER JOIN TB_AD_PRDTINF AD_PRD ON AD_PRD.PRDT_NUM = MCR.PRDT_NUM
            	AND AD_PRD.TRADE_STATUS = 'TS03'
            INNER JOIN TB_CORP CORP         ON CORP.CORP_ID = AD_PRD.CORP_ID
            	AND CORP.TRADE_STATUS_CD = 'TS03'
            INNER JOIN TB_AD_DFTINF AD_DFT  ON AD_DFT.CORP_ID = CORP.CORP_ID
            INNER JOIN TB_AD_AMTINF AD_AMT  ON AD_AMT.PRDT_NUM = AD_PRD.PRDT_NUM
	            AND AD_AMT.APL_DT = TO_CHAR (SYSDATE, 'YYYYMMDD')
                AND NVL(AD_AMT.SALE_AMT,0) > 0
                AND NVL(AD_AMT.NML_AMT,0) > 0
            INNER JOIN TB_AD_CNTINF AD_CNT  ON AD_CNT.PRDT_NUM = AD_PRD.PRDT_NUM
	            AND AD_CNT.APL_DT = TO_CHAR (SYSDATE, 'YYYYMMDD')
	            AND AD_CNT.DDL_YN = 'N'
            INNER JOIN TB_CM_IMG CM_IMG     ON CM_IMG.LINK_NUM = AD_DFT.CORP_ID
            	AND CM_IMG.IMG_SN = 1
        WHERE MCR.PRDT_DIV = 'AD'
        ORDER BY MCR.PRINT_SN) AD
WHERE RK = 1
</select>

<!-- 메인 카테고리 추천 상품_렌터카 -->
<select id="MAIN_S_30" resultMap="MAIN_R_27">
SELECT PRDT_DIV
    , PRDT_NUM
    , PRDT_NM
    , CORP_ID
    , PRDT_EXP
    , IMG_PATH
    , ETC_EXP
    , (CASE WHEN APPROX_NML_AMT IS NOT NULL THEN APPROX_NML_AMT ELSE TM24_AMT END) AS NML_AMT
    , (CASE WHEN APPROX_SALE_AMT IS NOT NULL THEN APPROX_SALE_AMT ELSE TRUNC ( (TM24_AMT * (100 - DIS_PER) / 100), - 2) END) AS SALE_AMT
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
        	INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
        		AND PRM.PRMT_DIV = 'EVNT'
            	AND PRM.STATUS_CD = 'TS03'
            	AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
        WHERE PRM_PRD.PRDT_NUM = RC.PRDT_NUM
            AND PRM.CORP_ID = RC.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE + 1, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = RC.PRDT_NUM) AS COUPON_CNT
    , '' AS DAYPRICE_YN
    , TAMNACARD_YN
FROM (SELECT MCR.PRDT_DIV
        , MCR.PRDT_NUM
        , RC_CAR.PRDT_NM
        , RC_PRD.CORP_ID
        , (SELECT CD_NM FROM TB_CD WHERE CD_NUM = RC_CAR.USE_FUEL_DIV) AS PRDT_EXP
        , RC_CAR.CAR_IMG AS IMG_PATH
        , CORP.CORP_NM AS ETC_EXP
        , RC_AMT.TM24_AMT
        , (CASE
                WHEN TO_NUMBER (RC_DFT.DIS_PER_APL_TM) > 24 THEN 0
                ELSE (CASE RC_DFT.WKD_DIS_PER_APL_YN
                            WHEN 'Y' THEN (CASE
                                                WHEN INSTR (RC_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR (SYSDATE + 1, 'D') - 1) > 0 THEN RC_DIS.WKD_DIS_PER
                                                ELSE RC_DIS.WDAY_DIS_PER
                                            END)
                            ELSE WDAY_DIS_PER
                        END)
            END) AS DIS_PER
        , RANK() OVER (PARTITION BY MCR.PRDT_NUM ORDER BY RC_AMT.APL_DT DESC, RC_DIS.DIS_PER_NUM DESC) AS RK
        , RC_PRD.APPROX_NML_AMT
        , RC_PRD.APPROX_SALE_AMT
        , CASE WHEN CORP.TAMNACARD_MNG_YN = 'C' OR (CORP.TAMNACARD_MNG_YN = 'P' AND RC_PRD.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
    FROM TB_MAIN_CTGR_RCMD MCR
        INNER JOIN TB_RC_PRDTINF RC_PRD   ON RC_PRD.PRDT_NUM = MCR.PRDT_NUM
            AND RC_PRD.TRADE_STATUS = 'TS03'
        INNER JOIN TB_CORP CORP           ON CORP.CORP_ID = RC_PRD.CORP_ID
            AND CORP.TRADE_STATUS_CD = 'TS03'
        INNER JOIN TB_RC_CARDIV RC_CAR    ON RC_CAR.RC_CARDIV_NUM = RC_PRD.RC_CARDIV_NUM
            AND RC_CAR.USE_YN = 'Y'
        INNER JOIN TB_RC_DFTINF RC_DFT    ON RC_DFT.CORP_ID = RC_PRD.CORP_ID
        INNER JOIN TB_RC_AMTINF RC_AMT    ON RC_AMT.PRDT_NUM = RC_PRD.PRDT_NUM
            <![CDATA[
            AND RC_AMT.APL_DT <= TO_CHAR (SYSDATE + 1, 'YYYYMMDD')
            ]]>
        INNER JOIN TB_RC_DISPERINF RC_DIS ON RC_DIS.PRDT_NUM = RC_PRD.PRDT_NUM
            AND TO_CHAR (SYSDATE + 1, 'YYYYMMDD') BETWEEN RC_DIS.APL_START_DT AND RC_DIS.APL_END_DT
    WHERE MCR.PRDT_DIV = 'RC'
    ORDER BY MCR.PRINT_SN) RC
WHERE RK = 1
</select>

<!-- 메인 카테고리 추천 상품_소셜 -->
<select id="MAIN_S_31" resultMap="MAIN_R_27">
SELECT PRDT_DIV
    , PRDT_NUM
    , PRDT_NM
    , CORP_ID
    , PRDT_EXP
    , IMG_PATH
    , ETC_EXP
    , NML_AMT
    , SALE_AMT
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
            INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
                AND PRM.PRMT_DIV = 'EVNT'
                AND PRM.STATUS_CD = 'TS03'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
        WHERE PRM_PRD.PRDT_NUM = SP.PRDT_NUM
            AND PRM.CORP_ID = SP.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = SP.PRDT_NUM) AS COUPON_CNT
    , '' AS DAYPRICE_YN
    , TAMNACARD_YN
FROM (SELECT
        MCR.PRDT_DIV
        , MCR.PRDT_NUM
        , SP_PRD.PRDT_NM
        , SP_PRD.CORP_ID
        , SP_PRD.PRDT_INF AS PRDT_EXP
        , CASE WHEN SP_PRD.API_IMG_THUMB IS NOT NULL THEN API_IMG_THUMB ELSE (CM_IMG.SAVE_PATH
                         || 'thumb/'
                         || CM_IMG.SAVE_FILE_NM) END AS IMG_PATH
        , CORP.CORP_NM AS ETC_EXP
        , SP_OPT.NML_AMT
        , SP_OPT.SALE_AMT
        , ROW_NUMBER() OVER (PARTITION BY MCR.PRDT_NUM ORDER BY SP_OPT.SALE_AMT) AS RK
        , CASE WHEN CORP.TAMNACARD_MNG_YN = 'C' OR (CORP.TAMNACARD_MNG_YN = 'P' AND SP_PRD.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
    FROM TB_MAIN_CTGR_RCMD MCR
        INNER JOIN TB_SP_PRDTINF SP_PRD ON SP_PRD.PRDT_NUM = MCR.PRDT_NUM
            AND TRADE_STATUS = 'TS03'
            AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN SP_PRD.SALE_START_DT AND SP_PRD.SALE_END_DT
        INNER JOIN TB_CORP CORP         ON CORP.CORP_ID = SP_PRD.CORP_ID
            AND CORP.TRADE_STATUS_CD = 'TS03'
        INNER JOIN TB_SP_OPTINF SP_OPT  ON SP_OPT.PRDT_NUM = SP_PRD.PRDT_NUM
            AND SP_OPT.PRINT_YN = 'Y'
            AND SP_OPT.SALE_AMT > 0
            AND SP_OPT.DDL_YN = 'N'
            AND SP_OPT.OPT_PRDT_NUM > SALE_NUM
            <![CDATA[
            AND (SP_OPT.APL_DT IS NULL OR SP_OPT.APL_DT >= TO_CHAR (SYSDATE, 'YYYYMMDD'))
            ]]>
        LEFT JOIN TB_CM_IMG CM_IMG     ON CM_IMG.LINK_NUM = SP_PRD.PRDT_NUM
            AND CM_IMG.IMG_SN = 1
    WHERE 1 = 1
        <isNotEmpty property="prdtDiv">
            AND MCR.PRDT_DIV = #prdtDiv#
        </isNotEmpty>
    ORDER BY MCR.PRINT_SN) SP
WHERE RK = 1
</select>

<!-- 메인 카테고리 추천 상품_특산기념품 -->
<select id="MAIN_S_32" resultMap="MAIN_R_27">
SELECT PRDT_DIV
    , PRDT_NUM
    , PRDT_NM
    , CORP_ID
    , PRDT_EXP
    , IMG_PATH
    , ETC_EXP
    , NML_AMT
    , SALE_AMT
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
        	INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
        		AND PRM.PRMT_DIV = 'EVNT'
            	AND PRM.STATUS_CD = 'TS03'
            	AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
        WHERE PRM_PRD.PRDT_NUM = SV.PRDT_NUM
            AND PRM.CORP_ID = SV.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = SV.PRDT_NUM) AS COUPON_CNT
    , '' AS DAYPRICE_YN
    , TAMNACARD_YN
FROM (SELECT MCR.PRDT_DIV
            , MCR.PRDT_NUM
            , SV_PRD.PRDT_NM
            , SV_PRD.CORP_ID
            , SV_PRD.PRDT_INF AS PRDT_EXP
            , (CM_IMG.SAVE_PATH || 'thumb/' || CM_IMG.SAVE_FILE_NM) AS IMG_PATH
            , CORP.CORP_NM AS ETC_EXP
            , SV_OPT.NML_AMT
            , SV_OPT.SALE_AMT
            , ROW_NUMBER() OVER (PARTITION BY MCR.PRDT_NUM ORDER BY SV_OPT.SALE_AMT) AS RK
            , CASE WHEN CORP.TAMNACARD_MNG_YN = 'C' OR (CORP.TAMNACARD_MNG_YN = 'P' AND SV_PRD.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
        FROM TB_MAIN_CTGR_RCMD MCR
            INNER JOIN TB_SV_PRDTINF AS SV_PRD ON SV_PRD.PRDT_NUM = MCR.PRDT_NUM
                AND SV_PRD.TRADE_STATUS = 'TS03'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN SV_PRD.SALE_START_DT AND SV_PRD.SALE_END_DT
            INNER JOIN TB_CORP CORP            ON CORP.CORP_ID = SV_PRD.CORP_ID
                AND CORP.TRADE_STATUS_CD = 'TS03'
            INNER JOIN TB_SV_OPTINF SV_OPT     ON SV_OPT.PRDT_NUM = SV_PRD.PRDT_NUM
                AND SV_OPT.SALE_AMT > 0
                AND SV_OPT.DDL_YN = 'N'
                AND SV_OPT.OPT_PRDT_NUM > SV_OPT.SALE_NUM
                AND SV_OPT.PRINT_YN = 'Y'
            INNER JOIN TB_CM_IMG CM_IMG        ON CM_IMG.LINK_NUM = SV_PRD.PRDT_NUM
                AND CM_IMG.IMG_SN = 1
        WHERE MCR.PRDT_DIV = 'SV'
        ORDER BY MCR.PRINT_SN) SV
WHERE RK = 1
</select>

<!-- 랭킹_소셜_메인 카테고리 추천 제외 -->
<select id="MAIN_S_33" resultMap="MAIN_R_02">
SELECT PRDT_NUM
    , CTGR
    , PRDT_DIV
    , PRDT_NM
    , CORP_ID
    , CORP_NM
    , SIMPLE_EXP
    , SP_DIV_SN
    , SP_OPT_SN
    , NML_AMT
    , SALE_AMT
    , DIS_PER
    , SAVE_PATH
    , SAVE_FILE_NM
    , GPA_AVG
    , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
        FROM TB_PRMT_PRDT PRM_PRD
            INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
                AND PRM.PRMT_DIV = 'EVNT'
                AND PRM.STATUS_CD = 'TS03'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
        WHERE PRM_PRD.PRDT_NUM = SP2.PRDT_NUM
            AND PRM.CORP_ID = SP2.CORP_ID) AS EVENT_CNT
    , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
        FROM TB_CP_PRDT CP_PRD
            INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
        WHERE CP_PRD.PRDT_NUM = SP2.PRDT_NUM) AS COUPON_CNT
FROM (SELECT ROWNUM AS RN
        , PRDT_NUM
        , PRDT_DIV
        , CTGR
        , PRDT_NM
        , CORP_ID
        , CORP_NM
        , SIMPLE_EXP
        , SP_DIV_SN
        , SP_OPT_SN
        , NML_AMT
        , SALE_AMT
        , DIS_PER
        , SAVE_PATH
        , SAVE_FILE_NM
        , (SELECT GPA_AVG FROM TB_GPA_ANLS WHERE LINK_NUM = SP.PRDT_NUM) AS GPA_AVG
        , (SELECT CORP_LEVEL - NVL (COMPLAIN_LEVEL, 0) + NVL (JOIN_LEVEL, 0) + NVL (AMT_LEVEL, 0)
            FROM TB_CORP_LEVEL
            WHERE CORP_ID = SP.CORP_ID) AS CORP_LEVEL
    FROM (SELECT SP_PRD.PRDT_NUM
            , SP_PRD.CTGR
            , SP_PRD.CORP_ID
            , CORP.CORP_NM
            , SP_PRD.PRDT_DIV
            , SP_PRD.PRDT_NM
            , SP_PRD.PRDT_INF AS SIMPLE_EXP
            , SP_OPT.SP_DIV_SN
            , SP_OPT.SP_OPT_SN
            , SP_OPT.NML_AMT
            , SP_OPT.SALE_AMT
            , (100 - (TRUNC (SP_OPT.SALE_AMT / SP_OPT.NML_AMT, 2) * 100)) AS DIS_PER
            , SP_PRD.CONF_DTTM
            , SP_OPT.SALE_NUM
            , CM_IMG.SAVE_PATH
            , CM_IMG.SAVE_FILE_NM
            , ROW_NUMBER () OVER (PARTITION BY SP_PRD.CORP_ID ORDER BY SP_OPT.SALE_AMT, SP_OPT.SP_DIV_SN, SP_OPT.SP_OPT_SN) AS RK
        FROM TB_SP_PRDTINF SP_PRD
            INNER JOIN TB_CORP CORP ON CORP.CORP_ID = SP_PRD.CORP_ID
                AND CORP.TRADE_STATUS_CD = 'TS03'
            INNER JOIN TB_SP_OPTINF SP_OPT ON SP_OPT.PRDT_NUM = SP_PRD.PRDT_NUM
                AND SP_OPT.PRINT_YN = 'Y'
                AND SP_OPT.SALE_AMT > 0
                AND SP_OPT.DDL_YN = 'N'
                AND SP_OPT.OPT_PRDT_NUM > SALE_NUM
                AND (SP_OPT.APL_DT IS NULL OR SP_OPT.APL_DT >= TO_CHAR (SYSDATE, 'YYYYMMDD'))
            INNER JOIN TB_CM_IMG CM_IMG ON CM_IMG.LINK_NUM = SP_PRD.PRDT_NUM
                AND CM_IMG.IMG_SN = 1
        WHERE SP_PRD.TRADE_STATUS = 'TS03'
            AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN SP_PRD.SALE_START_DT AND SP_PRD.SALE_END_DT
                <isNotEmpty property="sCtgr">
                    AND SUBSTR (SP_PRD.CTGR, 0, 2) = SUBSTR (#sCtgr#, 0, 2)
                    AND NOT EXISTS (SELECT 1  FROM TB_MAIN_CTGR_RCMD WHERE PRDT_NUM = SP_PRD.PRDT_NUM)
        ) SP
                </isNotEmpty>
        WHERE RK = 1
        ORDER BY CORP_LEVEL DESC) SP2
WHERE 1=1
    <isNotEmpty property="sNum">
        <![CDATA[
        AND ROWNUM <= 10
        ]]>
    </isNotEmpty>
</select>

<!-- 모바일 패키지 랜덤 부분 -->
<select id="MW_MAIN_S_01" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.APL_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'TOUR'
                   AND T_PRDT.CTGR IN ('C120' ,'C130' ,'C140' ,'C150')
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE RN < 9
 ]]>
</select>

<!-- 모바일 관광지 + 할인쿠폰 10개 -->
<select id="MW_MAIN_S_02" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , GPA_AVG
     , SAVE_PATH
     , SAVE_FILE_NM
  FROM (SELECT PRDT_NUM
             , CTGR
             , PRDT_DIV
             , PRDT_NM
             , SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , GPA_AVG
          FROM (SELECT PRDT_NUM
                     , CTGR
                     , PRDT_DIV
                     , PRDT_NM
                     , PRDT_INF AS SIMPLE_EXP
                     , 0 AS SP_DIV_SN
                     , 0 AS SP_OPT_SN
                     , 0 AS SALE_AMT
                     , 0 AS NML_AMT
                     , 0 AS DIS_PER
                     , NVL(T_GPA.GPA_AVG, 0) AS GPA_AVG
                  FROM TB_SP_PRDTINF T_PRDT
                  LEFT OUTER JOIN TB_GPA_ANLS T_GPA
                    ON T_GPA.LINK_NUM = T_PRDT.PRDT_NUM
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_DATE(SYSDATE, 'YYYY/MM/DD')*/
                   AND T_PRDT.SALE_END_DT >= TO_DATE(SYSDATE, 'YYYY/MM/DD')
                   AND T_PRDT.PRDT_DIV = 'FREE'
                UNION ALL
                SELECT PRDT_NUM
                     , CTGR
                     , PRDT_DIV
                     , PRDT_NM
                     , PRDT_INF AS SIMPLE_EXP
                     , SP_DIV_SN
                     , SP_OPT_SN
                     , SALE_AMT
                     , NML_AMT
                     , DIS_PER
                     , NVL(GPA.GPA_AVG, 0) AS GPA_AVG
                  FROM (SELECT T_PRDT.PRDT_NUM
                             , T_PRDT.CTGR
                             , T_PRDT.CORP_ID
                             , T_PRDT.PRDT_DIV
                             , T_PRDT.PRDT_NM
                             , T_PRDT.PRDT_INF
                             , T_OPT.SP_DIV_SN
                             , T_OPT.SP_OPT_SN
                             , T_OPT.SALE_AMT
                             , T_OPT.NML_AMT
                             , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                             , T_PRDT.CONF_DTTM
                             , T_OPT.SALE_NUM
                             , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                          FROM TB_SP_PRDTINF T_PRDT
                         INNER JOIN TB_SP_OPTINF T_OPT
                            ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                           AND T_OPT.DDL_YN = 'N'
                           AND T_OPT.PRINT_YN = 'Y'
                         WHERE 1=1
                           AND T_PRDT.TRADE_STATUS = 'TS03'
                           /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                           AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                           AND T_PRDT.PRDT_DIV = 'COUP'
                           AND T_PRDT.CTGR IN ('C210', 'C220', 'C230', 'C240')
                           AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
                       ) S
                  LEFT OUTER JOIN TB_GPA_ANLS GPA
                    ON S.PRDT_NUM = GPA.LINK_NUM
                 WHERE RK = 1
               )
         ORDER BY DBMS_RANDOM.VALUE
       ) R1
 INNER JOIN TB_CM_IMG R2
    ON R2.LINK_NUM = R1.PRDT_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 11
]]>
</select>

<select id="MW_MAIN_S_03" resultMap="MAIN_R_01">
<![CDATA[
SELECT CORP_ID
     , PRDT_NUM
     , PRDT_NM
     , CORP_NM
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT CORP_ID
             , PRDT_NUM
             , PRDT_NM
             , CORP_NM
             , NML_AMT
             , SALE_AMT
             , SIMPLE_EXP
             , DIS_PER
             , SAVE_PATH
             , SAVE_FILE_NM
             , GPA_AVG
          FROM (SELECT T_DFT.CORP_ID
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.PRDT_NM
                     , T_DFT.AD_NM          AS CORP_NM
                     , T_AMT.NML_AMT
                     , T_AMT.DAYPRICE_AMT	AS SALE_AMT
                     , T_DFT.AD_SIMPLE_EXP  AS SIMPLE_EXP
                     , CASE WHEN T_AMT.NML_AMT != 0 THEN 100 - (TRUNC(T_AMT.DAYPRICE_AMT / T_AMT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_IMG.SAVE_PATH
                     , T_IMG.SAVE_FILE_NM
                     , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
                     , ROW_NUMBER() OVER(PARTITION BY T_DFT.CORP_ID ORDER BY T_AMT.DAYPRICE_AMT ASC, T_PRDT.PRDT_NUM) AS RK
                  FROM TB_AD_PRDTINF T_PRDT
                 INNER JOIN TB_AD_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , SALE_AMT
                                  , NML_AMT
                                  , DAYPRICE_YN
                                  , DAYPRICE_AMT
                               FROM TB_AD_AMTINF
                              WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                                AND DAYPRICE_YN = 'Y'
                                AND DAYPRICE_AMT > 0
                            ) T_AMT
                    ON T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , TOTAL_ROOM_NUM
                                  , USE_ROOM_NUM
                                  , DDL_YN
                               FROM TB_AD_CNTINF
                              WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                                AND DDL_YN = 'N'
                                AND NVL(TOTAL_ROOM_NUM, 0) > NVL(USE_ROOM_NUM, 0)
                            ) T_CNT
                    ON T_CNT.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN TB_CM_IMG T_IMG
                    ON T_IMG.LINK_NUM = T_PRDT.CORP_ID
                   AND T_IMG.IMG_SN = 1
                  LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
                    ON T_ANLS.LINK_NUM = T_PRDT.PRDT_NUM
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               )
         WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
       )
 ]]>
</select>

<select id="MW_MAIN_S_04" resultMap="MAIN_R_11">
SELECT CORP_ID
    , PRDT_NUM
    , PRDT_NM
    , CORP_NM
    , NML_AMT
    , SALE_AMT
    , SIMPLE_EXP
    , DIS_PER
    , SAVE_PATH
    , SAVE_FILE_NM
    , GPA_AVG
    , DAYPRICE_YN
    , AD_AREA_NM
    , TAMNACARD_YN
  FROM (SELECT CORP_ID
            , PRDT_NUM
            , PRDT_NM
            , CORP_NM
            , NML_AMT
            , SALE_AMT
            , SIMPLE_EXP
            , DIS_PER
            , SAVE_PATH
            , SAVE_FILE_NM
            , GPA_AVG
            , BUY_NUM
            , DAYPRICE_YN
            , AD_AREA_NM
            , TAMNACARD_YN
          FROM (SELECT T_DFT.CORP_ID
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.PRDT_NM
                     , T_PRDT.BUY_NUM
                     , T_DFT.AD_NM          AS CORP_NM
                     , T_AMT.NML_AMT
                     , DECODE(T_AMT.DAYPRICE_YN, 'Y', T_AMT.DAYPRICE_AMT, T_AMT.SALE_AMT) AS SALE_AMT
                     , T_DFT.AD_SIMPLE_EXP  AS SIMPLE_EXP
                     , CASE WHEN T_AMT.NML_AMT != 0 THEN 100 - (TRUNC(DECODE(T_AMT.DAYPRICE_YN, 'Y', T_AMT.DAYPRICE_AMT, T_AMT.SALE_AMT) / T_AMT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_IMG.SAVE_PATH
                     , T_IMG.SAVE_FILE_NM
                     , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
                     , T_AMT.DAYPRICE_YN
                     , (SELECT CD_NM
			            FROM TB_CD
			            WHERE HRK_CD_NUM='ADAR'
			            AND CD_NUM=T_DFT.AD_AREA) AS AD_AREA_NM
                     , ROW_NUMBER() OVER(PARTITION BY T_DFT.CORP_ID ORDER BY DECODE(T_AMT.DAYPRICE_YN, 'Y', T_AMT.DAYPRICE_AMT, T_AMT.SALE_AMT) ASC, T_PRDT.PRDT_NUM) AS RK
                     , CASE WHEN T_CORP.TAMNACARD_MNG_YN = 'C' OR (T_CORP.TAMNACARD_MNG_YN = 'P' AND T_PRDT.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
                  FROM TB_AD_PRDTINF T_PRDT
                 INNER JOIN TB_AD_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN TB_CORP T_CORP
                    ON T_CORP.CORP_ID = T_DFT.CORP_ID
                   AND T_CORP.TRADE_STATUS_CD = 'TS03'
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , SALE_AMT
                                  , NML_AMT
                                  , DAYPRICE_YN
                                  , DAYPRICE_AMT
                               FROM TB_AD_AMTINF
                              WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                            ) T_AMT
                    ON T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN TB_CM_IMG T_IMG
                    ON T_IMG.LINK_NUM = T_PRDT.CORP_ID
                   AND T_IMG.IMG_SN = 1
                  LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
                    ON T_ANLS.LINK_NUM = T_PRDT.CORP_ID
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
               )
         WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
       )
<!-- <![CDATA[
 WHERE ROWNUM < 5
]]> -->
</select>

<!-- 모바일 메인 렌터카 조회
	2016.11.1 각 차량분류별로 2개씩 -->
<select id="MW_MAIN_S_05" resultMap="MAIN_R_01">
<![CDATA[
SELECT PRDT_NUM
     , PRDT_NM
     , CORP_ID
     , CORP_NM
     , DIS_PER
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT V_PRDT.PRDT_NUM
             , V_PRDT.PRDT_NM
             , V_PRDT.CORP_ID
             , V_PRDT.CORP_NM
             , V_PRDT.CONF_DTTM
             , V_PRDT.NML_AMT
             , V_PRDT.DIS_PER
             , V_PRDT.CAR_DIV
             , TRUNC((NML_AMT * (100 - DIS_PER) / 100), -2) AS SALE_AMT
             , '' AS SIMPLE_EXP
             , T_IMG.SAVE_PATH
		     , T_IMG.SAVE_FILE_NM
             , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
             , ROW_NUMBER() OVER(PARTITION BY V_PRDT.CAR_DIV ORDER BY V_PRDT.DIS_PER DESC, TRUNC((NML_AMT * (100 - DIS_PER) / 100), -2) ASC, DBMS_RANDOM.VALUE) AS RK
          FROM (SELECT T_PRDT.CORP_ID
                     , T_CORP.CORP_NM
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.CAR_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.CONF_DTTM
                     , T_AMT.TM24_AMT AS NML_AMT
                     , (CASE WHEN TO_NUMBER(T_DFT.DIS_PER_APL_TM) > 24
                             THEN 0
                             /*주말할인율 적용여부*/
                             ELSE (CASE T_DFT.WKD_DIS_PER_APL_YN
                                   WHEN 'Y'
                                   /*입력된 예약 시작일에 대한 요일 체크*/
                                   THEN (CASE WHEN INSTR(T_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR(SYSDATE, 'D') - 1) > 0
                                              THEN T_DISPER.WKD_DIS_PER
                                              ELSE T_DISPER.WDAY_DIS_PER
                                          END
                                        )
                                   ELSE T_DISPER.WDAY_DIS_PER
                                    END
                                  )
                          END) AS DIS_PER
                  FROM TB_RC_PRDTINF T_PRDT
                 INNER JOIN TB_RC_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN TB_CORP T_CORP
                    ON T_CORP.CORP_ID = T_PRDT.CORP_ID
                   AND T_CORP.TRADE_STATUS_CD = 'TS03'
                  /*요금*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , TM6_AMT
                                  , TM12_AMT
                                  , TM24_AMT
                                  , TM1_ADD_AMT
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY (TO_CHAR(SYSDATE+1, 'YYYYMMDD') - APL_DT)) AS RK
                               FROM TB_RC_AMTINF
                            ) T_AMT
                    ON T_AMT.RK = 1
                   AND T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                   /*할인율*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , DIS_PER_NUM
                                  , APL_START_DT
                                  , APL_END_DT
                                  , WDAY_DIS_PER
                                  , WKD_DIS_PER
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY DIS_PER_NUM DESC) AS RK
                               FROM TB_RC_DISPERINF
                              WHERE APL_START_DT <= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                AND APL_END_DT   >= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                            ) T_DISPER
                    ON T_DISPER.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_DISPER.RK = 1
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
               ) V_PRDT
         INNER JOIN TB_CM_IMG T_IMG
		    ON T_IMG.LINK_NUM = V_PRDT.PRDT_NUM
		   AND T_IMG.IMG_SN   = 1
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON T_ANLS.LINK_NUM = V_PRDT.PRDT_NUM
       )
 WHERE RK <= (CASE CAR_DIV WHEN 'CAR1'
                          THEN 2
                          WHEN 'CAR2'
                          THEN 2
                          WHEN 'CAR3'
                          THEN 2
                          WHEN 'CAR4'
                          THEN 2
                          ELSE 0
              END)
]]>
</select>

<!-- 모바일 음식 -->
<select id="MW_MAIN_S_06" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C3'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 5
 ]]>
</select>

<!-- 모바일 뷰티 -->
<select id="MW_MAIN_S_07" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND T_PRDT.CTGR IN ('C350')
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 6
 ]]>
</select>

<!-- 모바일 관광지/레저 -->
<select id="MW_MAIN_S_08" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(GPA.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     /* , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK */
                     , CASE
                                     WHEN T_PRDT.PRDT_DIV = 'TOUR' THEN ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM
                     ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC )
                                     WHEN T_PRDT.PRDT_DIV != 'TOUR' THEN ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM
                     ORDER BY T_DIV.VIEW_SN ASC, T_OPT.VIEW_SN ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC )
                                   END AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_DIVINF T_DIV
                 	ON T_DIV.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C2'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS GPA
            ON S.PRDT_NUM = GPA.LINK_NUM
	     WHERE RK = 1
         ORDER BY DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 5
 ]]>
</select>

<!-- 숙박 추천순 4개 -->
<select id="MW_MAIN_S_09" resultMap="MAIN_R_11">
SELECT CORP_ID
    , PRDT_NUM
    , PRDT_NM
    , CORP_NM
    , NML_AMT
    , SALE_AMT
    , SIMPLE_EXP
    , DIS_PER
    , SAVE_PATH
    , SAVE_FILE_NM
    , GPA_AVG
    , DAYPRICE_YN
    , AD_AREA_NM
    , TAMNACARD_YN
  FROM (SELECT CORP_ID
            , PRDT_NUM
            , PRDT_NM
            , CORP_NM
            , NML_AMT
            , SALE_AMT
            , SIMPLE_EXP
            , DIS_PER
            , SAVE_PATH
            , SAVE_FILE_NM
            , GPA_AVG
            , BUY_NUM
            , DAYPRICE_YN
            , AD_AREA_NM
            , TAMNACARD_YN
          FROM (SELECT T_DFT.CORP_ID
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.PRDT_NM
                     , T_PRDT.BUY_NUM
                     , T_DFT.AD_NM          AS CORP_NM
                     , T_AMT.NML_AMT
                     , DECODE(T_AMT.DAYPRICE_YN, 'Y', T_AMT.DAYPRICE_AMT, T_AMT.SALE_AMT) AS SALE_AMT
                     , T_DFT.AD_SIMPLE_EXP  AS SIMPLE_EXP
                     , CASE WHEN T_AMT.NML_AMT != 0 THEN 100 - (TRUNC(DECODE(T_AMT.DAYPRICE_YN, 'Y', T_AMT.DAYPRICE_AMT, T_AMT.SALE_AMT) / T_AMT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_IMG.SAVE_PATH
                     , T_IMG.SAVE_FILE_NM
                     , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
                     , T_AMT.DAYPRICE_YN
                     , (SELECT CD_NM
			            FROM TB_CD
			            WHERE HRK_CD_NUM='ADAR'
			            AND CD_NUM=T_DFT.AD_AREA) AS AD_AREA_NM
                     , ROW_NUMBER() OVER(PARTITION BY T_DFT.CORP_ID ORDER BY T_AMT.DAYPRICE_AMT ASC, T_PRDT.PRDT_NUM) AS RK
                     , CASE WHEN T_CORP.TAMNACARD_MNG_YN = 'C' OR (T_CORP.TAMNACARD_MNG_YN = 'P' AND T_PRDT.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
                  FROM TB_AD_PRDTINF T_PRDT
                 INNER JOIN TB_AD_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN TB_CORP T_CORP
                    ON T_CORP.CORP_ID = T_DFT.CORP_ID
                   AND T_CORP.TRADE_STATUS_CD = 'TS03'
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , SALE_AMT
                                  , NML_AMT
                                  , DAYPRICE_YN
                                  , DAYPRICE_AMT
                               FROM TB_AD_AMTINF
                              WHERE APL_DT = TO_CHAR(SYSDATE, 'YYYYMMDD')
                            ) T_AMT
                    ON T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                 INNER JOIN TB_CM_IMG T_IMG
                    ON T_IMG.LINK_NUM = T_PRDT.CORP_ID
                   AND T_IMG.IMG_SN = 1
                  LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
                    ON T_ANLS.LINK_NUM = T_PRDT.CORP_ID
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
               )
         WHERE RK = 1
         ORDER BY GPA_AVG DESC
                , DBMS_RANDOM.VALUE
       )
<!-- <![CDATA[
 WHERE ROWNUM < 5
]]> -->
</select>

<!-- 모바일 메인 렌터카 조회 추천순 5개 -->
<select id="MW_MAIN_S_10" resultMap="MAIN_R_01">
<![CDATA[
SELECT PRDT_NUM
     , PRDT_NM
     , CORP_ID
     , CORP_NM
     , DIS_PER
     , NML_AMT
     , SALE_AMT
     , SIMPLE_EXP
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT V_PRDT.PRDT_NUM
             , V_PRDT.PRDT_NM
             , V_PRDT.CORP_ID
             , V_PRDT.CORP_NM
             , V_PRDT.CONF_DTTM
             , V_PRDT.NML_AMT
             , V_PRDT.DIS_PER
             , TRUNC((NML_AMT * (100 - DIS_PER) / 100), -2) AS SALE_AMT
             , '' AS SIMPLE_EXP
             , T_IMG.SAVE_PATH
		     , T_IMG.SAVE_FILE_NM
             , NVL(T_ANLS.GPA_AVG, 0) AS GPA_AVG
          FROM (SELECT T_PRDT.CORP_ID
                     , T_CORP.CORP_NM
                     , T_PRDT.PRDT_NUM
                     , T_PRDT.PRDT_NM
                     , T_PRDT.CONF_DTTM
                     , T_AMT.TM24_AMT AS NML_AMT
                     , (CASE WHEN TO_NUMBER(T_DFT.DIS_PER_APL_TM) > 24
                             THEN 0
                             /*주말할인율 적용여부*/
                             ELSE (CASE T_DFT.WKD_DIS_PER_APL_YN
                                   WHEN 'Y'
                                   /*입력된 예약 시작일에 대한 요일 체크*/
                                   THEN (CASE WHEN INSTR(T_DFT.WKD_DIS_PER_APL_WEEK, TO_CHAR(SYSDATE, 'D') - 1) > 0
                                              THEN T_DISPER.WKD_DIS_PER
                                              ELSE T_DISPER.WDAY_DIS_PER
                                          END
                                        )
                                   ELSE T_DISPER.WDAY_DIS_PER
                                    END
                                  )
                          END) AS DIS_PER
                  FROM TB_RC_PRDTINF T_PRDT
                 INNER JOIN TB_RC_DFTINF T_DFT
                    ON T_DFT.CORP_ID = T_PRDT.CORP_ID
                 INNER JOIN TB_CORP T_CORP
                    ON T_CORP.CORP_ID = T_PRDT.CORP_ID
                   AND T_CORP.TRADE_STATUS_CD = 'TS03'
                  /*요금*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , APL_DT
                                  , TM6_AMT
                                  , TM12_AMT
                                  , TM24_AMT
                                  , TM1_ADD_AMT
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY (TO_CHAR(SYSDATE+1, 'YYYYMMDD') - APL_DT)) AS RK
                               FROM TB_RC_AMTINF
                            ) T_AMT
                    ON T_AMT.RK = 1
                   AND T_AMT.PRDT_NUM = T_PRDT.PRDT_NUM
                   /*할인율*/
                 INNER JOIN (SELECT PRDT_NUM
                                  , DIS_PER_NUM
                                  , APL_START_DT
                                  , APL_END_DT
                                  , WDAY_DIS_PER
                                  , WKD_DIS_PER
                                  , ROW_NUMBER() OVER(PARTITION BY PRDT_NUM ORDER BY DIS_PER_NUM DESC) AS RK
                               FROM TB_RC_DISPERINF
                              WHERE APL_START_DT <= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                                AND APL_END_DT   >= TO_CHAR(SYSDATE+1, 'YYYYMMDD')
                            ) T_DISPER
                    ON T_DISPER.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_DISPER.RK = 1
                 WHERE T_PRDT.TRADE_STATUS = 'TS03'
                 ]]>
				<![CDATA[
               ) V_PRDT
         INNER JOIN TB_CM_IMG T_IMG
		    ON T_IMG.LINK_NUM = V_PRDT.PRDT_NUM
		   AND T_IMG.IMG_SN   = 1
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON T_ANLS.LINK_NUM = V_PRDT.PRDT_NUM
         ORDER BY NVL(T_ANLS.GPA_AVG, 0) DESC
                , DBMS_RANDOM.VALUE
       )
 WHERE ROWNUM < 5
 ]]>
</select>

<!-- 모바일 관광지/레저 -->
<select id="MW_MAIN_S_11" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(T_ANLS.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C2'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON S.PRDT_NUM = T_ANLS.LINK_NUM
	     WHERE RK = 1
         ORDER BY NVL(T_ANLS.GPA_AVG, 0) DESC
                , DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 5
 ]]>
</select>


<!-- 모바일 음식/뷰티 -->
<select id="MW_MAIN_S_12" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(T_ANLS.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'COUP'
                   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C3'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON S.PRDT_NUM = T_ANLS.LINK_NUM
	     WHERE RK = 1
         ORDER BY NVL(T_ANLS.GPA_AVG, 0) DESC
                , DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 5
 ]]>
</select>

<!-- 모바일 패키지 추천 -->
<select id="MW_MAIN_S_13" resultMap="MAIN_R_02">
<![CDATA[
SELECT PRDT_NUM
     , CTGR
     , PRDT_DIV
     , PRDT_NM
     , SIMPLE_EXP
     , SP_DIV_SN
     , SP_OPT_SN
     , SALE_AMT
     , NML_AMT
     , DIS_PER
     , SAVE_PATH
     , SAVE_FILE_NM
     , GPA_AVG
  FROM (SELECT ROWNUM AS RN
             , PRDT_NUM
             , PRDT_DIV
             , CTGR
             , PRDT_NM
             , PRDT_INF AS SIMPLE_EXP
             , SP_DIV_SN
             , SP_OPT_SN
             , SALE_AMT
             , NML_AMT
             , DIS_PER
             , CONF_DTTM
             , SALE_NUM
             , NVL(T_ANLS.GPA_AVG, 0) GPA_AVG
          FROM (SELECT T_PRDT.PRDT_NUM
                     , T_PRDT.CTGR
                     , T_PRDT.CORP_ID
                     , T_PRDT.PRDT_DIV
                     , T_PRDT.PRDT_NM
                     , T_PRDT.PRDT_INF
                     , T_OPT.SP_DIV_SN
                     , T_OPT.SP_OPT_SN
                     , T_OPT.SALE_AMT
                     , T_OPT.NML_AMT
                     , CASE WHEN T_OPT.NML_AMT != 0 THEN 100 - (TRUNC(T_OPT.SALE_AMT / T_OPT.NML_AMT, 2) * 100) ELSE 0 END AS DIS_PER
                     , T_PRDT.CONF_DTTM
                     , T_OPT.SALE_NUM
                     , ROW_NUMBER( ) OVER (PARTITION BY T_PRDT.PRDT_NUM ORDER BY T_OPT.SALE_AMT ASC, T_OPT.SP_DIV_SN ASC, T_OPT.SP_OPT_SN ASC ) AS RK
                  FROM TB_SP_PRDTINF T_PRDT
                 INNER JOIN TB_SP_OPTINF T_OPT
                    ON T_OPT.PRDT_NUM = T_PRDT.PRDT_NUM
                   AND T_OPT.DDL_YN = 'N'
                   AND T_OPT.PRINT_YN = 'Y'
                 WHERE 1=1
                   AND T_PRDT.TRADE_STATUS = 'TS03'
                   /*AND T_PRDT.SALE_START_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD')*/
                   AND T_PRDT.SALE_END_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND T_PRDT.PRDT_DIV = 'TOUR'
                   AND SUBSTR(T_PRDT.CTGR, 0, 2) = 'C1'
                   AND (SELECT TRADE_STATUS_CD FROM TB_CORP WHERE CORP_ID=T_PRDT.CORP_ID)='TS03'
               ) S
          LEFT OUTER JOIN TB_GPA_ANLS T_ANLS
            ON S.PRDT_NUM = T_ANLS.LINK_NUM
	     WHERE RK = 1
         ORDER BY NVL(T_ANLS.GPA_AVG, 0) DESC
                , DBMS_RANDOM.VALUE
	 ) R1
  LEFT OUTER JOIN TB_CM_IMG R2
	ON R1.PRDT_NUM = R2.LINK_NUM
   AND R2.IMG_SN = 1
 WHERE ROWNUM < 5
 ]]>
</select>

<!-- 모바일 메인 특가상품 리스트 (랜덤 30개) -->
<select id="MW_MAIN_S_14" resultMap="MW_MAIN_R_14">
SELECT  CORP_ID
      , CORP_CD
      , PRDT_NUM
      , AD_NM AS PRDT_NM
      , SIMPLE_EXP
      , SALE_AMT
      , NML_AMT
      , SAVE_PATH
      , SAVE_FILE_NM
      , AD_AREA_NM
    FROM (SELECT  ROWNUM AS RN
          , T_PRDT5.CORP_ID
		  , T_COP.CORP_CD
          , PRDT_NUM
          , AD_NM
          , SIMPLE_EXP
          , AD_AREA
          , SALE_AMT
          , NML_AMT
          , SAVE_PATH
          , SAVE_FILE_NM
          , AD_AREA_NM
    FROM(
        SELECT CORP_ID
              , T_PRDT4.PRDT_NUM
              , AD_NM
              , SIMPLE_EXP
              , AD_AREA
              , SALE_AMT
              , NML_AMT
              , T_IMG.SAVE_PATH
              , T_IMG.SAVE_FILE_NM
              ,(SELECT CD_NM
                FROM TB_CD
                WHERE HRK_CD_NUM='ADAR'
                AND CD_NUM=AD_AREA) AS AD_AREA_NM

        FROM(
            SELECT T_SUM.CORP_ID
                 , PRDT_NUM
                 , AD_NM
                 , SIMPLE_EXP
                 , AD_AREA
                 , SALE_AMT
                 , NML_AMT
                 , ROW_NUMBER() OVER(PARTITION BY T_SUM.CORP_ID ORDER BY T_PRDT3.SALE_AMT ASC) AS RK
            FROM(
                SELECT T_PRDT.CORP_ID
                     , SUM(NVL(T_SA.BUY_NUM, 0)) AS SUM_NUM
                  FROM TB_AD_PRDTINF T_PRDT
                  LEFT OUTER JOIN (SELECT T_PRDT.CORP_ID
									    , SUM(T_ANLS.BUY_NUM) AS BUY_NUM
								     FROM TB_SALE_ANLS T_ANLS
								    INNER JOIN TB_AD_PRDTINF T_PRDT
									   ON T_PRDT.PRDT_NUM = T_ANLS.PRDT_NUM
									WHERE BUY_DT > TO_CHAR(SYSDATE - 30, 'YYYYMMDD')
									GROUP BY T_PRDT.CORP_ID
		                          ) T_SA
		            ON T_SA.CORP_ID = T_PRDT.CORP_ID
                 WHERE PRINT_YN='Y'
                   AND TRADE_STATUS='TS03'
                 GROUP BY T_PRDT.CORP_ID
            ) T_SUM
            INNER JOIN
            (
                SELECT T_PRDT2.PRDT_NUM
                        , PRDT_NM
                        , CORP_ID
                        , TRADE_STATUS
                        , PRINT_YN
                        , VIEW_SN
                        , CONF_REQUEST_DTTM
                        , AD_NM
                        , AD_SIMPLE_EXP AS SIMPLE_EXP
                        , AD_AREA
                        , T_AMT.SALE_AMT
                        , T_AMT.NML_AMT
                 FROM(
                       SELECT T_PRDT.PRDT_NUM
                            , T_PRDT.PRDT_NM
                            , T_PRDT.CORP_ID
                            , T_PRDT.TRADE_STATUS
                            , T_PRDT.PRINT_YN
                            , T_PRDT.VIEW_SN
                            , T_PRDT.CONF_REQUEST_DTTM
                            , T_DFT.AD_NM
                            , T_DFT.AD_SIMPLE_EXP
                            , T_DFT.AD_AREA
                         FROM TB_AD_PRDTINF T_PRDT
                        INNER JOIN TB_AD_DFTINF T_DFT
                           ON T_DFT.CORP_ID =  T_PRDT.CORP_ID
                        INNER JOIN TB_AD_AMTINF T_AMT
                           ON T_AMT.PRDT_NUM=T_PRDT.PRDT_NUM
                        WHERE PRINT_YN='Y'
                          AND TRADE_STATUS='TS03'
                          AND (
                            DAYPRICE_YN='Y'     /* 당일특가 상품 */
                            OR HOTDEALL_YN='Y'  /* 핫딜 상품 */
                            OR CTN_APL_YN='Y'   /* 연박할인 상품 */
                          )
                 ) T_PRDT2
                 LEFT OUTER JOIN (
                    SELECT PRDT_NUM, APL_DT, SALE_AMT, NML_AMT
                     FROM TB_AD_AMTINF
                     WHERE APL_DT = TO_CHAR(SYSDATE,'YYYYMMDD') ) T_AMT
                  ON T_PRDT2.PRDT_NUM = T_AMT.PRDT_NUM
            ) T_PRDT3
            ON T_PRDT3.CORP_ID = T_SUM.CORP_ID
        ) T_PRDT4
        LEFT OUTER JOIN TB_CM_IMG T_IMG
            ON T_IMG.LINK_NUM = T_PRDT4.CORP_ID
            AND T_IMG.IMG_SN   = 1
        WHERE RK=1
        ORDER BY DBMS_RANDOM.VALUE
        )AS T_PRDT5
    LEFT OUTER JOIN  TB_CORP T_COP
                ON T_COP.CORP_ID = T_PRDT5.CORP_ID
         WHERE T_COP.TRADE_STATUS_CD='TS03'
           AND SALE_AMT IS NOT NULL)
     <![CDATA[
   WHERE ROWNUM <= 30
     ]]>
</select>

<select id="BEST_AD_S_01" resultMap="BEST_AD_R_01">
   SELECT * FROM (
        SELECT CORP_ID,
        AD_NM,
        AD_SIMPLE_EXP,
        MIN(SALE_AMT) AS SALE_AMT,
        SUM(BUY_NUM) AS BUY_NUM,
        SAVE_PATH,
        SAVE_FILE_NM,
        TAMNACARD_YN
         FROM (
            SELECT
                A.CORP_ID,
              B.AD_NM,
              B.AD_SIMPLE_EXP,
              D.SALE_AMT,
              E.BUY_NUM,
              F.SAVE_PATH,
              F.SAVE_FILE_NM,
              CASE
                WHEN A.TAMNACARD_MNG_YN = 'C' OR
                (
                        A.TAMNACARD_MNG_YN  = 'P'
                AND     C.TAMNACARD_PRDT_YN = 'Y'
                )
                THEN 'Y'
                ELSE 'N'
                END                AS TAMNACARD_YN
            FROM TB_CORP AS A
            JOIN TB_AD_DFTINF AS B
            ON A.CORP_ID = B.CORP_ID
            JOIN TB_AD_PRDTINF AS C
            ON C.CORP_ID = B.CORP_ID
            JOIN TB_AD_AMTINF AS D
            ON C.PRDT_NUM = D.PRDT_NUM
            JOIN
            (SELECT A.PRDT_NUM, SUM(BUY_NUM) AS BUY_NUM
            FROM   TB_SALE_ANLS AS A
            WHERE  1                 =1
            AND A.PRDT_NUM LIKE 'AD%'
            AND A.BUY_DT BETWEEN TO_CHAR(SYSDATE-14,'YYYYMMDD') AND TO_CHAR(SYSDATE,'YYYYMMDD')
            AND A.BUY_NUM > 0
            GROUP BY PRDT_NUM
            ) AS E
            ON C.PRDT_NUM = E.PRDT_NUM
            JOIN TB_CM_IMG AS F
            ON      A.CORP_ID = F.LINK_NUM
            AND     F.IMG_SN  = 1
            WHERE 1=1
            AND D.APL_DT = TO_CHAR(SYSDATE+1,'YYYYMMDD')
            AND A.TRADE_STATUS_CD = 'TS03'
        ) GROUP BY CORP_ID,
        AD_NM,
        AD_SIMPLE_EXP,
        SAVE_PATH,
        SAVE_FILE_NM,
        TAMNACARD_YN
        ORDER BY BUY_NUM DESC
   )
   WHERE ROWNUM <![CDATA[<]]> 15
</select>

<insert id="TAMNAO_PARTNER_I_01">
    INSERT INTO TB_PARTNERS(
        PARTNER_CD,
        PARTNER_NM
    )VALUES(
       #partnerCd#,
       #partnerNm#
   )
</insert>

<select id="TAMNAO_PARTNER_S_01" resultMap="TAMNAO_PARTNER_R_01">
    SELECT
        RN,
        PARTNER_CD,
        PARTNER_NM,
        TOTAL_ACCESS_CNT
    FROM (
        SELECT
          ROWNUM AS RN,
          A.*
        FROM
          TB_PARTNERS AS A
        )
    WHERE RN BETWEEN TO_NUMBER(#firstIndex#)+1 AND TO_NUMBER(#lastIndex#)
    <isNotEmpty property="partnerCd">
    AND PARTNER_CD = #partnerCd#
    </isNotEmpty>

</select>

<select id="TAMNAO_PARTNER_S_02" resultClass="int">
    SELECT
        COUNT(*)
    FROM
        TB_PARTNERS
    WHERE 1=1
    <isNotEmpty property="partnerCd">
    AND PARTNER_CD = #partnerCd#
    </isNotEmpty>
</select>

<select id="TAMNAO_PARTNER_S_03" resultMap="TAMNAO_PARTNER_R_03">
    SELECT
        PARTNER_CD,
        PARTNER_NM
    FROM
        TB_PARTNERS
    WHERE PARTNER_CD = #partnerCd#
</select>

<update id="TAMNAO_PARTNER_U_01">
    UPDATE
        TB_PARTNERS
    SET
        PARTNER_CD = #partnerCd#,
        PARTNER_NM = #partnerNm#
    WHERE PARTNER_CD = #partnerCd#
</update>

<update id="TAMNAO_PARTNER_U_02">
    UPDATE
        TB_PARTNERS SET
    TOTAL_ACCESS_CNT = TOTAL_ACCESS_CNT + 1
    WHERE PARTNER_CD = #partnerCd#
</update>

<delete id="TAMNAO_PARTNER_D_01">
    DELETE
    FROM
        TB_PARTNERS
    WHERE
    PARTNER_CD = #partnerCd#
</delete>

<!-- 메인 카테고리 추천 상품_특산기념품 -->
<select id="MAIN_S_34" resultMap="MAIN_R_27">
    SELECT PRDT_DIV
         , PRDT_NUM
         , PRDT_NM
         , CORP_ID
         , PRDT_EXP
         , IMG_PATH
         , ETC_EXP
         , NML_AMT
         , SALE_AMT
         , (SELECT NVL (COUNT (PRM_PRD.PRMT_NUM), 0)
            FROM TB_PRMT_PRDT PRM_PRD
                     INNER JOIN TB_PRMT PRM ON PRM.PRMT_NUM = PRM_PRD.PRMT_NUM
                AND PRM.PRMT_DIV = 'EVNT'
                AND PRM.STATUS_CD = 'TS03'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN PRM.START_DT AND PRM.END_DT
            WHERE PRM_PRD.PRDT_NUM = SV.PRDT_NUM
              AND PRM.CORP_ID = SV.CORP_ID) AS EVENT_CNT
         , (SELECT NVL (COUNT (CP_PRD.PRDT_NUM), 0)
            FROM TB_CP_PRDT CP_PRD
                     INNER JOIN TB_CP CP ON CP.CP_ID = CP_PRD.CP_ID
                AND CP.STATUS_CD = 'ST02'
                AND CP.TGT_DIV = 'ALL'
                AND TO_CHAR (SYSDATE, 'YYYYMMDD') BETWEEN CP.APL_START_DT AND CP.APL_END_DT
            WHERE CP_PRD.PRDT_NUM = SV.PRDT_NUM) AS COUPON_CNT
         , '' AS DAYPRICE_YN
         , TAMNACARD_YN
    FROM (SELECT  'SV' AS PRDT_DIV
               , SV_PRD.PRDT_NUM
               , SV_PRD.PRDT_NM
               , SV_PRD.CORP_ID
               , SV_PRD.PRDT_INF AS PRDT_EXP
               , (CM_IMG.SAVE_PATH || 'thumb/' || CM_IMG.SAVE_FILE_NM) AS IMG_PATH
               , CORP.CORP_NM AS ETC_EXP
               , SV_OPT.NML_AMT
               , SV_OPT.SALE_AMT
               , ROW_NUMBER() OVER (PARTITION BY SV_PRD.PRDT_NUM ORDER BY SV_OPT.SALE_AMT) AS RK
               , CASE WHEN CORP.TAMNACARD_MNG_YN = 'C' OR (CORP.TAMNACARD_MNG_YN = 'P' AND SV_PRD.TAMNACARD_PRDT_YN = 'Y') THEN 'Y' ELSE 'N' END AS TAMNACARD_YN
            FROM TB_SV_PRDTINF AS SV_PRD
            INNER JOIN TB_CORP CORP
                ON CORP.CORP_ID = SV_PRD.CORP_ID AND CORP.TRADE_STATUS_CD = 'TS03'
            INNER JOIN TB_SV_OPTINF SV_OPT
                ON SV_OPT.PRDT_NUM = SV_PRD.PRDT_NUM
                AND SV_OPT.SALE_AMT > 0
                AND SV_OPT.DDL_YN = 'N'
                AND SV_OPT.OPT_PRDT_NUM > SV_OPT.SALE_NUM
                AND SV_OPT.PRINT_YN = 'Y'
            INNER JOIN TB_CM_IMG CM_IMG
                ON CM_IMG.LINK_NUM = SV_PRD.PRDT_NUM
                AND CM_IMG.IMG_SN = 1
          WHERE SIX_CERTI_CATE IS NOT NULL
            AND SV_PRD.TRADE_STATUS = 'TS03'
            AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN SV_PRD.SALE_START_DT AND SV_PRD.SALE_END_DT
          ) SV
    WHERE RK = 1
</select>

<select id="TAMNAO_PARTNER_S_04" resultMap="TAMNAO_PARTNER_R_04">
	SELECT YEAR
         , MM 
         , PARTNER_CD
         , ACCESS_CNT
	  FROM TB_PARTNERS_LOG
     WHERE PARTNER_CD = #partnerCd#
  ORDER BY YEAR DESC, MM DESC
</select>

</sqlMap>
